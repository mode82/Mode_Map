<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MAPMODE Â· ADMIN99</title>
  <style>
    :root{
      color-scheme: dark;
      --bg:#0a0f18;
      --bg2:#070b12;

      --panel:#0b1220cc;
      --card:#0e1626cc;
      --stroke:#1f2a3a;
      --stroke2:#27344a;

      --text:#e7eef8;
      --muted:#9fb0c6;
      --accent:#7cc4ff;
      --danger:#ff5d5d;
      --ok:#39d98a;
      --warn:#ffd60a;

      --r12:12px;
      --r14:14px;
      --r16:16px;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --shadow2: 0 8px 24px rgba(0,0,0,.35);
      --blur: 14px;

      --topH:58px;
      --sideW:320px;
      --sideW2:350px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", Arial, sans-serif;
      background: radial-gradient(1200px 700px at 50% -10%, rgba(124,196,255,.18), transparent 55%),
                  radial-gradient(800px 600px at 90% 10%, rgba(57,217,138,.12), transparent 55%),
                  radial-gradient(800px 600px at 10% 10%, rgba(255,214,10,.08), transparent 55%),
                  linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
      color:var(--text);
      overflow:hidden;
    }

    /* TOPBAR */
    .topbar{
      position:fixed; inset:0 0 auto 0;
      height:var(--topH);
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 14px;
      z-index:80;
      background: linear-gradient(180deg, rgba(9,14,23,.88), rgba(9,14,23,.58));
      backdrop-filter: blur(var(--blur));
      border-bottom:1px solid rgba(39,52,74,.65);
    }
    .top-left, .top-right{ display:flex; align-items:center; gap:10px; }

    .slot{
      height:38px;
      display:flex; align-items:center;
      padding:0 10px;
      border-radius:999px;
      background: rgba(14,22,38,.55);
      border:1px solid rgba(39,52,74,.65);
      box-shadow: var(--shadow2);
      gap:8px;
      white-space:nowrap;
    }
    .slot.fixed{ width:170px; justify-content:center; }
    .slot.logo{
      justify-content:flex-start;
      border:none;
      background: transparent;
      box-shadow:none;
      padding:0;
      width:170px;
    }
    .logoBox{
      width:170px; height:38px;
      border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
      background: transparent;
      border:none;
      cursor:pointer;
      user-select:none;
    }
    .logoBox img{ height:26px; width:auto; display:block; opacity:.98; }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:900; letter-spacing:.5px;
    }
    .brand .word{ font-size:20px; line-height:1; display:flex; align-items:center; }
    .brand .word .o{
      display:inline-block;
      width:12px; height:12px; border-radius:999px;
      margin:0 2px;
      background:#fff;
      box-shadow: 0 0 0 2px rgba(255,255,255,.12);
      transform: translateY(1px);
    }

    .select{
      appearance:none; border:none; background:transparent; color:var(--text);
      font-weight:900; padding-right:18px; outline:none; cursor:pointer;
    }
    .chev{
      width:0; height:0;
      border-left:5px solid transparent;
      border-right:5px solid transparent;
      border-top:6px solid rgba(231,238,248,.7);
      margin-left:-8px;
      pointer-events:none;
    }

    .pill{
      height:34px;
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px;
      padding:0 12px;
      border-radius:999px;
      background: rgba(14,22,38,.55);
      border:1px solid rgba(39,52,74,.65);
      color:var(--text);
      box-shadow: var(--shadow2);
      cursor:pointer;
      user-select:none;
      text-decoration:none;
      font-weight:900;
    }
    .pill:hover{ border-color: rgba(124,196,255,.55); }
    .pill:active{ transform: translateY(1px); }
    .pill.small{ height:32px; padding:0 10px; font-size:13px; font-weight:900; }
    .pill.ghost{ background: rgba(14,22,38,.25); }
    .pill.danger{ border-color: rgba(255,93,93,.55); }

    /* LAYOUT */
    .layout{
      position:fixed;
      inset:var(--topH) 0 0 0;
      display:grid;
      grid-template-columns: var(--sideW) 1fr var(--sideW2);
      height:calc(100% - var(--topH));
    }

    .side{
      overflow:hidden;
      border-right:1px solid rgba(39,52,74,.55);
      background: rgba(8,12,20,.35);
      backdrop-filter: blur(var(--blur));
    }
    .side.right{ border-right:none; border-left:1px solid rgba(39,52,74,.55); }

    .sideInner{
      height:100%;
      padding:12px;
      overflow:auto;
    }

    .card{
      background: rgba(14,22,38,.50);
      border:1px solid rgba(39,52,74,.6);
      border-radius: var(--r16);
      padding:12px;
      box-shadow: var(--shadow2);
    }
    .card + .card{ margin-top:12px; }

    .sectionTitle{
      font-size:12px; letter-spacing:.3px;
      color: rgba(231,238,248,.8);
      margin:4px 0 10px 0;
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
    }
    .subtle{ color: rgba(159,176,198,.92); font-size:12px; line-height:1.45; }

    /* LEFT pages */
    .row{ display:flex; gap:10px; align-items:center; }
    .grow{ flex:1; }
    .input{
      width:100%;
      height:38px;
      border-radius: 12px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      color: var(--text);
      padding:0 12px;
      outline:none;
    }
    .input:focus{ border-color: rgba(124,196,255,.6); box-shadow: 0 0 0 3px rgba(124,196,255,.08); }

    .pageList{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }
    .pageItem{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 10px;
      border-radius: var(--r14);
      border:1px solid rgba(39,52,74,.6);
      background: rgba(14,22,38,.35);
      cursor:pointer;
    }
    .pageItem.active{
      outline:2px solid rgba(57,217,138,.35);
      border-color: rgba(57,217,138,.55);
      background: rgba(14,22,38,.55);
    }
    .pageItem .name{ font-weight:900; font-size:13px; }
    .miniBtns{ display:flex; gap:8px; }
    .miniBtn{
      width:28px; height:28px;
      border-radius:10px;
      border:1px solid rgba(39,52,74,.6);
      background: rgba(10,15,24,.35);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      color: rgba(231,238,248,.9);
      user-select:none;
      font-weight:900;
      font-size:12px;
    }
    .miniBtn:hover{ border-color: rgba(124,196,255,.55); }

    /* CENTER canvas */
    .center{
      position:relative;
      overflow:hidden;
      background:
        radial-gradient(900px 700px at 50% 15%, rgba(124,196,255,.08), transparent 60%),
        radial-gradient(900px 700px at 50% 80%, rgba(57,217,138,.05), transparent 60%);
    }
    .canvasWrap{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    canvas{ background: transparent; touch-action:none; }

    .hintToast{
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      top:14px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.6);
      background: rgba(14,22,38,.55);
      color: rgba(231,238,248,.9);
      box-shadow: var(--shadow2);
      font-size:12px;
      display:none;
      z-index:40;
    }
    .hintToast.show{ display:block; }

    /* RIGHT categories + marker list */
    .chipRow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .chip{
      display:flex; align-items:center; gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.6);
      background: rgba(10,15,24,.35);
      cursor:pointer;
      font-size:12px;
      user-select:none;
    }
    .chip.on{ border-color: rgba(124,196,255,.6); background: rgba(124,196,255,.10); }
    .dotc{ width:9px; height:9px; border-radius:999px; box-shadow:0 0 0 2px rgba(255,255,255,.06); }

    .hr{ height:1px; background: rgba(39,52,74,.55); margin:10px 0; }

    .kpi{
      margin-top:10px;
      font-size:12px;
      color: rgba(231,238,248,.85);
      display:flex; justify-content:space-between;
    }

    .btnFull{ width:100%; height:42px; border-radius:14px; justify-content:center; }

    /* Modal */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      display:none;
      z-index:200;
    }
    .overlay.show{ display:block; }
    .modal{
      position:absolute;
      inset: 6% 6%;
      background: linear-gradient(180deg, rgba(14,22,38,.95), rgba(10,15,24,.90));
      border:1px solid rgba(39,52,74,.75);
      border-radius: 20px;
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .modalHead{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(39,52,74,.55);
    }
    .modalHead h3{
      margin:0;
      font-size:18px;
      font-weight:900;
    }
    .modalBody{
      padding:16px;
      overflow:auto;
      flex:1;
    }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    .label{
      font-size:12px;
      color: rgba(159,176,198,.95);
      margin:0 0 6px 2px;
    }
    .textarea{
      width:100%;
      min-height:120px;
      border-radius: 14px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      color: var(--text);
      padding:12px;
      outline:none;
      resize:vertical;
    }
    .textarea:focus{ border-color: rgba(124,196,255,.6); box-shadow: 0 0 0 3px rgba(124,196,255,.08); }

    .selectBox{
      width:100%;
      height:38px;
      border-radius:12px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      color: var(--text);
      padding:0 12px;
      outline:none;
    }
    .checkboxRow{ display:flex; align-items:center; gap:10px; margin-top:6px; }
    .rangeRow{
      display:flex; align-items:center; gap:12px;
      padding:10px 12px;
      border-radius: 16px;
      border:1px solid rgba(39,52,74,.55);
      background: rgba(10,15,24,.22);
    }
    input[type="range"]{ width: 100%; }
    .pillNum{
      width:64px; text-align:center;
      height:34px; border-radius:12px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      color:var(--text);
      font-weight:900;
      outline:none;
    }

    /* Quick colors */
    .colorRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .swatch{
      width:36px; height:28px;
      border-radius:10px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      user-select:none;
    }
    .swatch > div{
      width:14px; height:14px; border-radius:6px;
      box-shadow:0 0 0 2px rgba(255,255,255,.08);
    }

    /* Auth */
    .auth{
      position:fixed; inset:0;
      display:none;
      z-index:300;
      background: rgba(0,0,0,.65);
      backdrop-filter: blur(12px);
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    .auth.show{ display:flex; }
    .authCard{
      width:min(520px, 96vw);
      background: linear-gradient(180deg, rgba(14,22,38,.95), rgba(10,15,24,.90));
      border:1px solid rgba(39,52,74,.75);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding:18px;
    }
    .authTitle{ font-weight:900; font-size:18px; margin:0 0 10px; }
    .authHint{ color: rgba(159,176,198,.95); font-size:12px; margin:0 0 12px; line-height:1.5; }
    .authRow{ display:flex; gap:10px; align-items:center; }
    .authRow .input{ height:42px; }
    .authErr{ color: rgba(255,93,93,.95); font-size:12px; margin-top:10px; display:none; }
    .authErr.show{ display:block; }

    /* Same layout on mobile: keep columns, allow horizontal scroll if needed */
    @media (max-width: 1200px){
      body{ overflow:auto; }
      .layout{
        width: calc(var(--sideW) + 1000px + var(--sideW2));
        min-width: calc(var(--sideW) + 1000px + var(--sideW2));
      }
      .center{ min-width: 1000px; }
    }
  </style>
</head>
<body>

  <!-- AUTH -->
  <div class="auth" id="auth">
    <div class="authCard">
      <p class="authTitle">ê´€ë¦¬ì ì¸ì¦</p>
      <p class="authHint">
        ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ë©´ <b>24ì‹œê°„</b> ì¸ì¦ì´ ìœ ì§€ë©ë‹ˆë‹¤.<br/>
        (admin99 ì „ìš© / ê¸°ì¡´ admin82ì—ëŠ” ì˜í–¥ ì—†ìŒ)
      </p>
      <div class="authRow">
        <input class="input" id="authPw" type="password" inputmode="numeric" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" />
        <button class="pill" id="authBtn" type="button">ì ‘ì†</button>
      </div>
      <div class="authErr" id="authErr">ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
    </div>
  </div>

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="top-left">
      <!-- Slot 1: Logo placeholder -->
      <div class="slot fixed logo">
        <div class="logoBox" id="logoBox" title="ë¡œê³  URL ì„¤ì •">
          <div class="brand"><div class="word">MAPM<span class="o"></span>DE</div></div>
        </div>
      </div>

      <!-- Slot 2: Game -->
      <div class="slot fixed">
        <select id="gameSelect" class="select" title="ê²Œì„ ì„ íƒ">
          <option value="ì•„ì´ì˜¨2">ì•„ì´ì˜¨2</option>
        </select>
        <div class="chev"></div>
      </div>

      <!-- Slot 3: ADMIN badge -->
      <div class="slot fixed">
        <div style="font-weight:900; color:rgba(231,238,248,.92);">ADMIN</div>
        <div style="width:8px;height:8px;border-radius:999px;background:var(--ok);box-shadow:0 0 0 4px rgba(57,217,138,.12);"></div>
      </div>

      <!-- Slot 4: Controls -->
      <div class="slot fixed" style="justify-content:center;">
        <label class="pill small ghost" style="gap:8px; cursor:pointer;">
          ì§€ë„ ì—…ë¡œë“œ
          <input id="mapUpload" type="file" accept="image/*" style="display:none;">
        </label>
        <button class="pill small ghost" id="btnExport">state99.json ë‚´ë³´ë‚´ê¸°</button>
        <button class="pill small danger" id="btnResetAll" title="ë°ì´í„° ì´ˆê¸°í™”">ì „ì²´ ì´ˆê¸°í™”</button>
      </div>
    </div>

    <div class="top-right">
      <a class="pill small ghost" href="./index99.html" target="_blank" rel="noopener">ìœ ì € ë³´ê¸°</a>
    </div>
  </div>

  <div class="layout">
    <!-- LEFT: Pages -->
    <aside class="side left">
      <div class="sideInner">
        <div class="card">
          <div class="sectionTitle">
            <span>í˜ì´ì§€</span>
            <span class="subtle"><b id="pathGame">ì•„ì´ì˜¨2</b> / <b id="pathPage">ì „ì²´ì§€ë„</b></span>
          </div>

          <div class="row">
            <input class="input grow" id="pageName" placeholder="í˜ì´ì§€ ì´ë¦„" />
            <button class="pill small" id="btnAddPage" type="button">ì¶”ê°€</button>
          </div>

          <div class="subtle" style="margin-top:10px;">
            â€¢ í˜ì´ì§€ëŠ” â€œê° ì§€ë„ íƒ­â€ì…ë‹ˆë‹¤. (ì „ì²´ì§€ë„, 2ë²ˆë§ˆì„â€¦ ë“±)<br/>
            â€¢ í˜ì´ì§€ë³„ë¡œ ë§ˆì»¤ê°€ ë¶„ë¦¬ë©ë‹ˆë‹¤.
          </div>

          <div class="pageList" id="pageList"></div>
        </div>

        <div class="card">
          <div class="sectionTitle">
            <span>ë¡œê³ </span>
            <span class="subtle">URLë¡œ ì„¤ì •</span>
          </div>
          <div class="row">
            <input class="input grow" id="logoUrl" placeholder="ë¡œê³  ì´ë¯¸ì§€ URL" />
            <button class="pill small" id="btnSaveLogo" type="button">ì ìš©</button>
          </div>
          <div class="subtle" style="margin-top:10px;">
            â€¢ ìƒë‹¨ ì²« ë²ˆì§¸ ìŠ¬ë¡¯(ë¡œê³  ìë¦¬)ì€ <b>í…Œë‘ë¦¬ ì—†ìŒ</b><br/>
            â€¢ ë¡œê³  URL ë¹„ìš°ë©´ ê¸°ë³¸ MAPMODE í…ìŠ¤íŠ¸ë¡œ í‘œì‹œ
          </div>
        </div>
      </div>
    </aside>

    <!-- CENTER: Canvas -->
    <main class="center">
      <div class="hintToast" id="toast"></div>
      <div class="canvasWrap">
        <canvas id="cv" width="1200" height="900"></canvas>
      </div>
    </main>

    <!-- RIGHT: Marker edit + categories -->
    <aside class="side right">
      <div class="sideInner">

        <div class="card">
          <div class="sectionTitle">
            <span>ì¹´í…Œê³ ë¦¬</span>
            <span class="subtle">í‘œì‹œ í•„í„°</span>
          </div>
          <div class="chipRow" id="catChips"></div>
          <div class="hr"></div>

          <div class="sectionTitle" style="margin-top:0;">
            <span>ì„ íƒí•œ ë§ˆì»¤</span>
            <span class="subtle" id="selMarkerInfo">ì—†ìŒ</span>
          </div>

          <button class="pill btnFull danger" id="btnClearDim" type="button" style="border-color:rgba(255,93,93,.65);">ë§ˆì»¤ ì´ˆê¸°í™”</button>

          <div class="hr"></div>

          <div class="kpi">
            <span id="kpiShown">í‘œì‹œ ì¤‘: 0</span>
            <span id="kpiTotal">ë§ˆì»¤: 0</span>
          </div>

          <div style="margin-top:10px;">
            <button class="pill btnFull" id="btnFit" type="button">í™”ë©´ ë§ì¶¤</button>
          </div>

          <div class="subtle" style="margin-top:10px;">
            â€¢ <b>ìš°í´ë¦­</b>(ëª¨ë°”ì¼: ê¸¸ê²Œ ëˆ„ë¥´ê¸°)ë¡œ ë§ˆì»¤ ì¶”ê°€<br/>
            â€¢ ë§ˆì»¤ í´ë¦­ â†’ í¸ì§‘ì°½ ì—´ê¸°<br/>
            â€¢ íœ /í•€ì¹˜ë¡œ í™•ëŒ€ì¶•ì†Œ, ë“œë˜ê·¸ë¡œ ì´ë™
          </div>
        </div>

      </div>
    </aside>
  </div>

  <!-- MARKER EDIT MODAL -->
  <div class="overlay" id="editOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div>
          <h3>ë§ˆì»¤ í¸ì§‘</h3>
          <div class="subtle" style="margin-top:4px;">
            ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ í¸ì§‘/ì‚­ì œ ê°€ëŠ¥í•©ë‹ˆë‹¤. <b>(Enter = ì €ì¥)</b>
          </div>
        </div>
        <button class="pill" id="btnCloseEdit" type="button">ë‹«ê¸°</button>
      </div>

      <div class="modalBody">
        <div class="grid2">
          <div>
            <div class="label">ì´ë¦„(ë§ˆì»¤ ì´ë¦„)</div>
            <input class="input" id="mName" placeholder="ì˜ˆ: ê¸°í…” ìœ„ì¹˜" />
          </div>
          <div>
            <div class="label">ì¹´í…Œê³ ë¦¬</div>
            <select class="selectBox" id="mCat"></select>
          </div>
        </div>

        <div style="margin-top:14px;">
          <div class="label">ë§ˆì»¤ ì› ìƒ‰ìƒ</div>
          <div class="rangeRow" style="gap:14px;">
            <input class="input" id="mColor" placeholder="#2b8cff ë˜ëŠ” red" />
            <div class="checkboxRow">
              <input type="checkbox" id="mUseCatColor" />
              <label for="mUseCatColor" class="subtle" style="cursor:pointer;">ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ì‚¬ìš©</label>
            </div>
            <div class="swatch" title="ë¯¸ë¦¬ë³´ê¸°"><div id="mColorPreview"></div></div>
          </div>
          <div class="subtle" style="margin-top:8px;">
            â€¢ â€œì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ì‚¬ìš©â€ ì²´í¬ ì‹œ, ê°œë³„ ìƒ‰ìƒì€ ë¬´ì‹œë©ë‹ˆë‹¤.
          </div>
        </div>

        <div class="grid2" style="margin-top:14px;">
          <div>
            <div class="label">ìœ íŠœë¸Œ ë§í¬(URL)</div>
            <input class="input" id="mYt" placeholder="https://www.youtube.com/watch?v=..." />
          </div>
          <div>
            <div class="label">ìœ íŠœë¸Œ í‘œì‹œëª…(ìœ ì €ëª¨ë“œ ì œëª©)</div>
            <input class="input" id="mYtTitle" placeholder="ì˜ˆ: ê¸°í…” 1ë²ˆìœ„ì¹˜" />
          </div>
        </div>

        <div style="margin-top:14px;">
          <div class="label">ë©”ëª¨ (ê´€ë¦¬ì ë“±ë¡)</div>
          <textarea class="textarea" id="mMemo" placeholder="ê´€ë¦¬ì ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ìœ ì € ëª¨ë“œì—ì„œëŠ” ì½ê¸° ì „ìš©ì…ë‹ˆë‹¤."></textarea>
        </div>

        <div class="hr"></div>

        <div class="sectionTitle" style="margin-top:0;">
          <span>ë§ˆì»¤ ìŠ¤íƒ€ì¼</span>
          <span class="subtle">ì› í¬ê¸° / ê¸€ì”¨ í¬ê¸° / êµµê¸°Â·ìƒ‰ìƒ</span>
        </div>

        <div class="grid2">
          <div class="card" style="padding:12px;">
            <div class="label">ì› í¬ê¸°</div>
            <div class="rangeRow">
              <input type="range" id="mR" min="4" max="30" value="10" />
              <input class="pillNum" id="mRNum" type="number" min="4" max="30" value="10" />
              <div class="subtle">px</div>
            </div>
            <div class="subtle" style="margin-top:10px;">
              * ì› í¬ê¸° ë³€ê²½ ì‹œ ê¸€ì”¨ í¬ê¸°ë„ ê°™ì€ ë¹„ìœ¨ë¡œ ìë™ ë³€ê²½ë©ë‹ˆë‹¤.
            </div>
          </div>

          <div class="card" style="padding:12px;">
            <div class="label">ê¸€ì”¨ í¬ê¸°</div>
            <div class="rangeRow">
              <input type="range" id="mFS" min="10" max="26" value="15" />
              <input class="pillNum" id="mFSNum" type="number" min="10" max="26" value="15" />
              <div class="subtle">ë¼ë²¨</div>
            </div>
            <div class="subtle" style="margin-top:10px;">
              * í˜„ì¬ëŠ” â€œì› í¬ê¸°â€ê°€ ìš°ì„ (ìë™ ë™ê¸°í™”)ì…ë‹ˆë‹¤.
            </div>
          </div>
        </div>

        <div class="grid2" style="margin-top:14px;">
          <div class="card" style="padding:12px;">
            <div class="label">êµµê¸°(ë¼ë²¨)</div>
            <select class="selectBox" id="mFW">
              <option value="900">900 (Black)</option>
              <option value="800">800 (ExtraBold)</option>
              <option value="700">700 (Bold)</option>
              <option value="600">600 (SemiBold)</option>
            </select>
            <div class="label" style="margin-top:10px;">ê¸€ì”¨ ìƒ‰ìƒ(ë¼ë²¨)</div>
            <div class="row">
              <input class="input grow" id="mLabelColor" placeholder="#e7eef8" />
              <button class="pill small ghost" id="btnLabelDefault" type="button">ê¸°ë³¸ê°’</button>
            </div>

            <div class="label" style="margin-top:10px;">ë¹ ë¥¸ ê¸€ì”¨ ìƒ‰</div>
            <div class="colorRow" id="quickLabelColors"></div>
          </div>

          <div class="card" style="padding:12px;">
            <div class="label">ë¹ ë¥¸ ë§ˆì»¤ ìƒ‰(ì¹´í…Œê³ ë¦¬)</div>
            <div class="colorRow" id="quickMarkerColors"></div>

            <div class="hr"></div>
            <div class="subtle">
              ì¢Œí‘œ(ë¹„ìœ¨): <span id="mPos">-</span>
            </div>

            <div class="subtle" style="margin-top:10px;">
              â€¢ â€œìƒˆë¡œìš´ ë²ˆí˜¸ë¡œ ì‹œì‘ / ì´ì–´ì„œ ì‹œì‘â€ì€ ì—¬ê¸°ì„œëŠ” ìƒëµ(ì½”ë“œ ê¸¸ì´ ì¶•ì†Œ ëª©ì ).<br/>
              â€¢ ì²´ì¸(ì„  ì—°ê²°)ì€ â€œchainId + chainIndexâ€ë¡œë§Œ ìœ ì§€ë©ë‹ˆë‹¤.
            </div>
          </div>
        </div>

        <div style="height:16px;"></div>
      </div>

      <div class="modalHead" style="border-top:1px solid rgba(39,52,74,.55); border-bottom:none;">
        <div class="subtle" id="editHint">ì €ì¥/ì‚­ì œ</div>
        <div style="display:flex; gap:10px;">
          <button class="pill danger" id="btnDelete" type="button">ì‚­ì œ</button>
          <button class="pill" id="btnSave" type="button" style="border-color:rgba(57,217,138,.55);">ì €ì¥</button>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  /******************************************************************
   * admin99 ì „ìš© ë¶„ë¦¬ ì„¤ì •
   ******************************************************************/
  const LS_KEY = "mapmode_state_v99";          // âœ… v99 ì „ìš© localStorage
  const AUTH_KEY = "mapmode_admin99_auth_v1";  // âœ… v99 ì „ìš© ì¸ì¦
  const ADMIN_PASSWORD = "0000000001";
  const AUTH_TTL_MS = 24 * 60 * 60 * 1000;     // âœ… 24ì‹œê°„

  const defaultCats = [
    { id:"ì „ì²´", name:"ì „ì²´", color:"#7cc4ff", on:true },
    { id:"ë³´ìŠ¤", name:"ë³´ìŠ¤", color:"#ff5d5d", on:true },
    { id:"ê¸°í…”", name:"ê¸°í…”", color:"#ffd60a", on:true },
    { id:"íë¸Œ", name:"íë¸Œ", color:"#2b8cff", on:true },
  ];
  const defaultState = {
    version:99,
    game:"ì•„ì´ì˜¨2",
    logoUrl:"",
    pages: [{id:"p_all", name:"ì „ì²´ì§€ë„", url:""}],
    currentPageId:"p_all",
    categories: defaultCats,
    markerLabelDefault:"#e7eef8",
    map:{ imgDataUrl:"", naturalW:1, naturalH:1, scale:0, tx:0, ty:0 },
    markers:[],   // {id,pageId,x,y,cat,name,yt,ytTitle,memo,r,fs,fw,labelColor,useCatColor,colorOverride,chainId,chainIndex}
    chains:[]     // keep for future
  };

  const $ = (id)=>document.getElementById(id);
  const cv = $("cv");
  const ctx = cv.getContext("2d");
  const toastEl = $("toast");

  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const uid = ()=>Math.random().toString(16).slice(2)+Date.now().toString(16);
  const safeParse = (json, fallback) => { try{ return JSON.parse(json); }catch(e){ return fallback; } };

  let S = loadState();
  function loadState(){
    const raw = localStorage.getItem(LS_KEY);
    const st = raw ? safeParse(raw, null) : null;
    if(!st || typeof st !== "object") return structuredClone(defaultState);
    const merged = structuredClone(defaultState);
    Object.assign(merged, st);
    merged.pages = Array.isArray(st.pages) && st.pages.length ? st.pages : structuredClone(defaultState.pages);
    merged.categories = Array.isArray(st.categories) && st.categories.length ? st.categories : structuredClone(defaultCats);
    merged.markers = Array.isArray(st.markers) ? st.markers : [];
    merged.chains = Array.isArray(st.chains) ? st.chains : [];
    merged.map = Object.assign(structuredClone(defaultState.map), st.map||{});
    return merged;
  }
  function saveState(){
    localStorage.setItem(LS_KEY, JSON.stringify(S));
  }

  function toast(msg, ms=1200){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>toastEl.classList.remove("show"), ms);
  }
  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  /******************************************************************
   * AUTH (24h)
   ******************************************************************/
  const auth = $("auth");
  const authPw = $("authPw");
  const authBtn = $("authBtn");
  const authErr = $("authErr");

  function isAuthed(){
    const t = Number(localStorage.getItem(AUTH_KEY) || "0");
    return (t && (Date.now() - t) < AUTH_TTL_MS);
  }
  function requireAuth(){
    if(isAuthed()){
      auth.classList.remove("show");
      return;
    }
    auth.classList.add("show");
    authPw.value = "";
    authPw.focus();
  }
  function doAuth(){
    if(authPw.value === ADMIN_PASSWORD){
      localStorage.setItem(AUTH_KEY, String(Date.now()));
      auth.classList.remove("show");
      authErr.classList.remove("show");
      toast("ì¸ì¦ ì™„ë£Œ");
    }else{
      authErr.classList.add("show");
    }
  }
  authBtn.addEventListener("click", doAuth);
  authPw.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doAuth(); });

  requireAuth();

  /******************************************************************
   * LOGO
   ******************************************************************/
  const logoBox = $("logoBox");
  const logoUrl = $("logoUrl");
  const btnSaveLogo = $("btnSaveLogo");

  function renderLogo(){
    logoBox.innerHTML = "";
    if(S.logoUrl){
      const img = document.createElement("img");
      img.src = S.logoUrl;
      img.alt = "logo";
      img.onerror = () => {
        logoBox.innerHTML = `<div class="brand"><div class="word">MAPM<span class="o"></span>DE</div></div>`;
      };
      logoBox.appendChild(img);
    }else{
      logoBox.innerHTML = `<div class="brand"><div class="word">MAPM<span class="o"></span>DE</div></div>`;
    }
    logoUrl.value = S.logoUrl || "";
  }
  renderLogo();

  btnSaveLogo.addEventListener("click", ()=>{
    S.logoUrl = (logoUrl.value||"").trim();
    saveState();
    renderLogo();
    toast("ë¡œê³  ì ìš©");
  });
  logoBox.addEventListener("click", ()=>{
    logoUrl.focus();
    toast("ë¡œê³  URLì„ ì…ë ¥ í›„ ì ìš©");
  });

  /******************************************************************
   * TOP: game (fixed AION2)
   ******************************************************************/
  const gameSelect = $("gameSelect");
  const pathGame = $("pathGame");
  const pathPage = $("pathPage");
  gameSelect.value = "ì•„ì´ì˜¨2";
  pathGame.textContent = "ì•„ì´ì˜¨2";
  gameSelect.addEventListener("change", ()=>{
    gameSelect.value = "ì•„ì´ì˜¨2";
    toast("í˜„ì¬ëŠ” ì•„ì´ì˜¨2ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤");
  });

  /******************************************************************
   * PAGES
   ******************************************************************/
  const pageName = $("pageName");
  const btnAddPage = $("btnAddPage");
  const pageList = $("pageList");

  function ensurePages(){
    if(!S.pages || !S.pages.length){
      S.pages = structuredClone(defaultState.pages);
      S.currentPageId = S.pages[0].id;
    }
    if(!S.pages.find(p=>p.id===S.currentPageId)){
      S.currentPageId = S.pages[0].id;
    }
  }
  function renderPages(){
    ensurePages();
    pageList.innerHTML = "";
    const cur = S.pages.find(p=>p.id===S.currentPageId) || S.pages[0];
    pathPage.textContent = cur ? cur.name : "ì „ì²´ì§€ë„";

    for(const p of S.pages){
      const item = document.createElement("div");
      item.className = "pageItem" + (p.id===S.currentPageId ? " active" : "");
      item.innerHTML = `
        <div class="name">${escapeHtml(p.name)}</div>
        <div class="miniBtns">
          <div class="miniBtn" title="ì´ë¦„ ë³€ê²½">âœ</div>
          <div class="miniBtn" title="ì‚­ì œ">ğŸ—‘</div>
        </div>
      `;
      const [btnEdit, btnDel] = item.querySelectorAll(".miniBtn");
      item.addEventListener("click", (e)=>{
        if(e.target === btnEdit || e.target === btnDel) return;
        S.currentPageId = p.id;
        saveState();
        renderPages();
        renderKPIs();
        clearSelection();
        draw();
      });
      btnEdit.addEventListener("click", ()=>{
        const n = prompt("í˜ì´ì§€ ì´ë¦„", p.name);
        if(n==null) return;
        const nn = n.trim();
        if(!nn){ toast("ì´ë¦„ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤"); return; }
        p.name = nn;
        saveState();
        renderPages();
        toast("í˜ì´ì§€ ì´ë¦„ ë³€ê²½");
      });
      btnDel.addEventListener("click", ()=>{
        if(S.pages.length<=1){ toast("ìµœì†Œ 1ê°œ í˜ì´ì§€ëŠ” í•„ìš”í•©ë‹ˆë‹¤"); return; }
        if(!confirm(`"${p.name}" í˜ì´ì§€ë¥¼ ì‚­ì œí• ê¹Œìš”?\n(í•´ë‹¹ í˜ì´ì§€ì˜ ë§ˆì»¤ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤)`)) return;
        S.pages = S.pages.filter(x=>x.id!==p.id);
        S.markers = S.markers.filter(m=>m.pageId!==p.id);
        if(S.currentPageId === p.id) S.currentPageId = S.pages[0].id;
        saveState();
        renderPages();
        renderKPIs();
        clearSelection();
        draw();
        toast("ì‚­ì œ ì™„ë£Œ");
      });
      pageList.appendChild(item);
    }
  }

  btnAddPage.addEventListener("click", ()=>{
    const n = (pageName.value||"").trim();
    if(!n){ toast("í˜ì´ì§€ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"); return; }
    const p = { id:"p_"+uid(), name:n, url:"" };
    S.pages.push(p);
    S.currentPageId = p.id;
    pageName.value = "";
    saveState();
    renderPages();
    renderKPIs();
    clearSelection();
    draw();
    toast("í˜ì´ì§€ ì¶”ê°€");
  });

  /******************************************************************
   * CATEGORIES (toggle + color)
   ******************************************************************/
  const catChips = $("catChips");
  function getCat(id){ return S.categories.find(c=>c.id===id); }

  function renderCats(){
    catChips.innerHTML = "";
    if(!S.categories || !S.categories.length) S.categories = structuredClone(defaultCats);

    for(const c of S.categories){
      const chip = document.createElement("div");
      chip.className = "chip" + (c.on ? " on" : "");
      chip.innerHTML = `<div class="dotc" style="background:${c.color};"></div><div style="font-weight:900;">${escapeHtml(c.name)}</div>`;
      chip.addEventListener("click", ()=>{
        c.on = !c.on;
        if(!S.categories.some(x=>x.on)){
          c.on = true;
          toast("ìµœì†Œ 1ê°œ ì¹´í…Œê³ ë¦¬ëŠ” ì¼œì ¸ì•¼ í•©ë‹ˆë‹¤");
        }
        saveState();
        renderCats();
        renderKPIs();
        draw();
      });
      chip.addEventListener("contextmenu", (e)=>{
        e.preventDefault();
        const col = prompt(`${c.name} ìƒ‰ìƒ ë³€ê²½ (#rrggbb)`, c.color);
        if(col==null) return;
        const cc = col.trim();
        if(!cc) return;
        c.color = cc;
        saveState();
        renderCats();
        draw();
        toast("ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ë³€ê²½");
      });
      catChips.appendChild(chip);
    }
  }

  /******************************************************************
   * MAP IMAGE
   ******************************************************************/
  const mapUpload = $("mapUpload");
  let mapImg = new Image();
  mapImg.crossOrigin = "anonymous";
  mapImg.onload = ()=>{
    S.map.naturalW = mapImg.naturalWidth || 1;
    S.map.naturalH = mapImg.naturalHeight || 1;
    if(!S.map.scale || S.map.scale<=0) fitToScreen();
    saveState();
    draw();
  };

  function loadMap(){
    if(S.map.imgDataUrl){
      mapImg = new Image();
      mapImg.onload = ()=>{
        S.map.naturalW = mapImg.naturalWidth || 1;
        S.map.naturalH = mapImg.naturalHeight || 1;
        if(!S.map.scale || S.map.scale<=0) fitToScreen();
        draw();
      };
      mapImg.src = S.map.imgDataUrl;
      return;
    }
    // placeholder
    mapImg = new Image();
    mapImg.onload = ()=>draw();
    mapImg.src = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(
      `<svg xmlns="http://www.w3.org/2000/svg" width="1400" height="1000">
        <defs>
          <radialGradient id="g" cx="50%" cy="40%" r="70%">
            <stop offset="0%" stop-color="#ffffff"/>
            <stop offset="100%" stop-color="#e8edf7"/>
          </radialGradient>
        </defs>
        <rect width="100%" height="100%" fill="url(#g)"/>
        <text x="50%" y="50%" text-anchor="middle" font-family="Arial" font-size="28" fill="#7a889e">ì§€ë„ ì—…ë¡œë“œê°€ í•„ìš”í•©ë‹ˆë‹¤</text>
      </svg>`
    );
  }

  mapUpload.addEventListener("change", async ()=>{
    const f = mapUpload.files && mapUpload.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      const dataUrl = String(reader.result||"");
      S.map.imgDataUrl = dataUrl;
      saveState();
      loadMap();
      toast("ì§€ë„ ì—…ë¡œë“œ ì™„ë£Œ");
    };
    reader.readAsDataURL(f);
  });

  /******************************************************************
   * CANVAS resize
   ******************************************************************/
  function resizeCanvas(){
    const wrap = cv.parentElement;
    const w = wrap.clientWidth - 32;
    const h = wrap.clientHeight - 32;
    cv.width = Math.max(900, Math.floor(w));
    cv.height = Math.max(650, Math.floor(h));
  }
  window.addEventListener("resize", ()=>{ resizeCanvas(); draw(); });

  function fitToScreen(){
    const pad = 40;
    const iw = S.map.naturalW || (mapImg.naturalWidth||1);
    const ih = S.map.naturalH || (mapImg.naturalHeight||1);
    const cw = cv.width, ch = cv.height;
    const scale = Math.min((cw - pad)/iw, (ch - pad)/ih);
    S.map.scale = clamp(scale, 0.05, 10);
    S.map.tx = (cw - iw*S.map.scale)/2;
    S.map.ty = (ch - ih*S.map.scale)/2;
  }

  $("btnFit").addEventListener("click", ()=>{
    fitToScreen();
    saveState();
    draw();
    toast("í™”ë©´ ë§ì¶¤");
  });

  /******************************************************************
   * MARKERS: visibility + draw
   ******************************************************************/
  let dimmedMarkerId = null;
  let selectedMarkerId = null;

  function getVisibleMarkers(){
    const curPage = S.currentPageId;
    const onCats = new Set(S.categories.filter(c=>c.on).map(c=>c.id));
    const allOn = onCats.has("ì „ì²´");
    return (S.markers||[]).filter(m=>{
      if(m.pageId !== curPage) return false;
      if(allOn) return true;
      return onCats.has(m.cat);
    });
  }
  function markerColor(m){
    if(!m) return "#7cc4ff";
    if(m.useCatColor){
      const c = getCat(m.cat);
      return (c && c.color) ? c.color : "#7cc4ff";
    }
    if(m.colorOverride && m.colorOverride.trim()) return m.colorOverride.trim();
    const c = getCat(m.cat);
    return (c && c.color) ? c.color : "#7cc4ff";
  }

  function renderKPIs(){
    const curPage = S.currentPageId;
    const total = (S.markers||[]).filter(m=>m.pageId===curPage).length;
    const shown = getVisibleMarkers().length;
    $("kpiTotal").textContent = "ë§ˆì»¤: " + total;
    $("kpiShown").textContent = "í‘œì‹œ ì¤‘: " + shown;

    const sel = S.markers.find(m=>m.id===selectedMarkerId);
    $("selMarkerInfo").textContent = sel ? (sel.name || "(ì´ë¦„ ì—†ìŒ)") : "ì—†ìŒ";
  }

  function worldFromScreen(sx, sy){
    return { x:(sx - S.map.tx)/S.map.scale, y:(sy - S.map.ty)/S.map.scale };
  }
  function worldFromNorm(nx, ny){
    const iw = S.map.naturalW || (mapImg.naturalWidth||1);
    const ih = S.map.naturalH || (mapImg.naturalHeight||1);
    return { x:nx*iw, y:ny*ih };
  }
  function normFromWorld(wx, wy){
    const iw = S.map.naturalW || (mapImg.naturalWidth||1);
    const ih = S.map.naturalH || (mapImg.naturalHeight||1);
    return { nx: clamp(wx/iw, 0, 1), ny: clamp(wy/ih, 0, 1) };
  }

  function pickMarkerAt(sx, sy){
    const w = worldFromScreen(sx, sy);
    const ms = getVisibleMarkers();
    let best=null, bestD=Infinity;
    for(const m of ms){
      const p = worldFromNorm(m.x, m.y);
      const r = (m.r ?? 10);
      const dx = p.x - w.x, dy = p.y - w.y;
      const d = Math.sqrt(dx*dx + dy*dy);
      if(d <= r*1.3 && d < bestD){ best=m; bestD=d; }
    }
    return best;
  }

  function draw(){
    ctx.clearRect(0,0,cv.width,cv.height);

    // bg
    ctx.save();
    ctx.fillStyle = "rgba(0,0,0,.22)";
    ctx.fillRect(0,0,cv.width,cv.height);
    ctx.restore();

    // world
    ctx.save();
    ctx.translate(S.map.tx, S.map.ty);
    ctx.scale(S.map.scale, S.map.scale);

    // map
    if(mapImg && mapImg.complete){
      const iw = S.map.naturalW || (mapImg.naturalWidth||1);
      const ih = S.map.naturalH || (mapImg.naturalHeight||1);
      ctx.drawImage(mapImg, 0,0, iw, ih);
    }

    const ms = getVisibleMarkers();

    // chains lines
    const byChain = new Map();
    for(const m of ms){
      if(!m.chainId || !m.chainIndex) continue;
      if(!byChain.has(m.chainId)) byChain.set(m.chainId, []);
      byChain.get(m.chainId).push(m);
    }
    ctx.lineWidth = 2 / S.map.scale;
    ctx.strokeStyle = "rgba(255,255,255,.78)";
    ctx.globalAlpha = 0.9;
    for(const arr of byChain.values()){
      arr.sort((a,b)=>(a.chainIndex||0)-(b.chainIndex||0));
      if(arr.length<2) continue;
      ctx.beginPath();
      for(let i=0;i<arr.length;i++){
        const p = worldFromNorm(arr[i].x, arr[i].y);
        if(i===0) ctx.moveTo(p.x, p.y);
        else ctx.lineTo(p.x, p.y);
      }
      ctx.stroke();
    }

    // markers
    for(const m of ms){
      const p = worldFromNorm(m.x, m.y);
      const r = (m.r ?? 10);
      const col = markerColor(m);

      const circleAlpha = (dimmedMarkerId === m.id) ? 0.30 : 1.0;

      // circle
      ctx.save();
      ctx.globalAlpha = circleAlpha;
      ctx.beginPath();
      ctx.arc(p.x, p.y, r, 0, Math.PI*2);
      ctx.fillStyle = col;
      ctx.fill();
      ctx.lineWidth = 2 / S.map.scale;
      ctx.strokeStyle = (m.id===selectedMarkerId) ? "rgba(124,196,255,.9)" : "rgba(0,0,0,.35)";
      ctx.stroke();
      ctx.restore();

      // number
      const num = (m.chainIndex != null) ? String(m.chainIndex) : "";
      if(num){
        ctx.save();
        ctx.globalAlpha = 0.98;
        ctx.fillStyle = "rgba(0,0,0,.75)";
        ctx.font = `${m.fw ?? 900} ${Math.max(10, Math.round((m.fs ?? 15) * 0.95))}px ui-sans-serif`;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(num, p.x, p.y + 0.5);
        ctx.restore();
      }

      // label (admin preview)
      if(m.name){
        ctx.save();
        ctx.globalAlpha = 0.98;
        ctx.fillStyle = m.labelColor || (S.markerLabelDefault || "#e7eef8");
        ctx.font = `${m.fw ?? 900} ${m.fs ?? 15}px ui-sans-serif`;
        ctx.textAlign = "left";
        ctx.textBaseline = "middle";
        const off = r + 8;
        ctx.fillText(m.name, p.x + off, p.y);
        ctx.restore();
      }
    }

    ctx.restore();
  }

  /******************************************************************
   * PAN/ZOOM
   ******************************************************************/
  let isPanning=false, lastX=0,lastY=0;

  cv.addEventListener("pointerdown", (e)=>{
    cv.setPointerCapture(e.pointerId);
    lastX=e.clientX; lastY=e.clientY;
    isPanning=true;
  });
  cv.addEventListener("pointermove", (e)=>{
    if(!isPanning) return;
    const dx=e.clientX-lastX, dy=e.clientY-lastY;
    lastX=e.clientX; lastY=e.clientY;
    S.map.tx += dx;
    S.map.ty += dy;
    draw();
  });
  cv.addEventListener("pointerup", ()=>{ isPanning=false; });
  cv.addEventListener("pointercancel", ()=>{ isPanning=false; });

  cv.addEventListener("wheel", (e)=>{
    e.preventDefault();
    const rect = cv.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;

    const old = S.map.scale || 1;
    const zoom = Math.exp(-e.deltaY * 0.0012);
    const next = clamp(old * zoom, 0.05, 10);

    const wx = (mx - S.map.tx) / old;
    const wy = (my - S.map.ty) / old;

    S.map.scale = next;
    S.map.tx = mx - wx * next;
    S.map.ty = my - wy * next;

    draw();
  }, {passive:false});

  /******************************************************************
   * ADD marker by right click / long press
   ******************************************************************/
  function addMarkerAtNorm(nx, ny){
    const m = {
      id:"m_"+uid(),
      pageId:S.currentPageId,
      x:nx, y:ny,
      cat:"íë¸Œ",
      name:"",
      yt:"",
      ytTitle:"",
      memo:"",
      r:10, fs:15, fw:900,
      labelColor:S.markerLabelDefault,
      useCatColor:true,
      colorOverride:"",
      chainId:"c_"+S.currentPageId, // default one chain per page
      chainIndex: nextChainIndexForPage()
    };
    S.markers.push(m);
    saveState();
    renderKPIs();
    selectedMarkerId = m.id;
    openEdit(m.id);
    draw();
    toast("ë§ˆì»¤ ì¶”ê°€");
  }
  function nextChainIndexForPage(){
    const ms = (S.markers||[]).filter(m=>m.pageId===S.currentPageId && m.chainId==="c_"+S.currentPageId && typeof m.chainIndex==="number");
    const max = ms.reduce((a,m)=>Math.max(a,m.chainIndex||0), 0);
    return max + 1;
  }

  cv.addEventListener("contextmenu", (e)=>{
    e.preventDefault();
    if(!isAuthed()){ requireAuth(); return; }
    const rect = cv.getBoundingClientRect();
    const sx = e.clientX - rect.left;
    const sy = e.clientY - rect.top;
    const w = worldFromScreen(sx, sy);
    const n = normFromWorld(w.x, w.y);
    addMarkerAtNorm(n.nx, n.ny);
  });

  // Long press for mobile
  let lpTimer=null, lpStart=null;
  cv.addEventListener("pointerdown", (e)=>{
    if(e.pointerType !== "touch") return;
    const rect = cv.getBoundingClientRect();
    lpStart = { x: e.clientX - rect.left, y: e.clientY - rect.top };
    clearTimeout(lpTimer);
    lpTimer = setTimeout(()=>{
      if(!isAuthed()){ requireAuth(); return; }
      const w = worldFromScreen(lpStart.x, lpStart.y);
      const n = normFromWorld(w.x, w.y);
      addMarkerAtNorm(n.nx, n.ny);
    }, 520);
  });
  cv.addEventListener("pointermove", (e)=>{
    if(!lpStart) return;
    const rect = cv.getBoundingClientRect();
    const x = e.clientX - rect.left, y = e.clientY - rect.top;
    if(Math.hypot(x-lpStart.x, y-lpStart.y) > 12){
      clearTimeout(lpTimer);
    }
  });
  cv.addEventListener("pointerup", ()=>{ clearTimeout(lpTimer); lpStart=null; });
  cv.addEventListener("pointercancel", ()=>{ clearTimeout(lpTimer); lpStart=null; });

  /******************************************************************
   * select marker / dim marker / edit
   ******************************************************************/
  cv.addEventListener("click", (e)=>{
    const rect = cv.getBoundingClientRect();
    const sx = e.clientX - rect.left;
    const sy = e.clientY - rect.top;
    const hit = pickMarkerAt(sx, sy);
    if(hit){
      selectedMarkerId = hit.id;
      dimmedMarkerId = hit.id;   // adminì—ì„œë„ í´ë¦­í•˜ë©´ dim 30%
      renderKPIs();
      draw();
      openEdit(hit.id);
    }else{
      clearSelection();
      draw();
    }
  });

  function clearSelection(){
    selectedMarkerId = null;
    dimmedMarkerId = null;
    renderKPIs();
  }

  $("btnClearDim").addEventListener("click", ()=>{
    dimmedMarkerId = null;
    selectedMarkerId = null;
    renderKPIs();
    draw();
    toast("ë§ˆì»¤ ì´ˆê¸°í™”");
  });

  /******************************************************************
   * EXPORT state99.json
   ******************************************************************/
  $("btnExport").addEventListener("click", ()=>{
    if(!isAuthed()){ requireAuth(); return; }
    // ì €ì¥ í›„ export
    saveState();
    const blob = new Blob([JSON.stringify(S, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "state99.json"; // âœ… admin99 ì „ìš© íŒŒì¼ëª…
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    toast("state99.json ë‚´ë³´ë‚´ê¸° ì™„ë£Œ");
  });

  /******************************************************************
   * RESET ALL (admin99 only)
   ******************************************************************/
  $("btnResetAll").addEventListener("click", ()=>{
    if(!isAuthed()){ requireAuth(); return; }
    if(!confirm("admin99 ë°ì´í„°ë¥¼ ëª¨ë‘ ì´ˆê¸°í™”í• ê¹Œìš”?\n(ê¸°ì¡´ admin82/indexì—ëŠ” ì˜í–¥ ì—†ìŒ)")) return;
    localStorage.removeItem(LS_KEY);
    S = structuredClone(defaultState);
    saveState();
    renderLogo();
    renderPages();
    renderCats();
    renderEditCatOptions();
    resizeCanvas();
    loadMap();
    fitToScreen();
    clearSelection();
    renderKPIs();
    draw();
    toast("ì´ˆê¸°í™” ì™„ë£Œ");
  });

  /******************************************************************
   * EDIT MODAL
   ******************************************************************/
  const editOverlay = $("editOverlay");
  const btnCloseEdit = $("btnCloseEdit");
  const btnSave = $("btnSave");
  const btnDelete = $("btnDelete");

  const mName = $("mName");
  const mCat = $("mCat");
  const mColor = $("mColor");
  const mUseCatColor = $("mUseCatColor");
  const mColorPreview = $("mColorPreview");
  const mYt = $("mYt");
  const mYtTitle = $("mYtTitle");
  const mMemo = $("mMemo");
  const mR = $("mR");
  const mRNum = $("mRNum");
  const mFS = $("mFS");
  const mFSNum = $("mFSNum");
  const mFW = $("mFW");
  const mLabelColor = $("mLabelColor");
  const btnLabelDefault = $("btnLabelDefault");
  const mPos = $("mPos");

  // sync flags (name -> ytTitle/memo only if they were auto)
  let autoYtTitle = true;
  let autoMemo = true;
  let editingId = null;

  function renderEditCatOptions(){
    mCat.innerHTML = "";
    for(const c of S.categories){
      if(c.id === "ì „ì²´") continue;
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = c.name;
      mCat.appendChild(opt);
    }
  }

  function openEdit(id){
    if(!isAuthed()){ requireAuth(); return; }
    const m = S.markers.find(x=>x.id===id);
    if(!m) return;
    editingId = id;

    renderEditCatOptions();

    mName.value = m.name || "";
    mCat.value = (m.cat && m.cat!=="ì „ì²´") ? m.cat : "íë¸Œ";

    mUseCatColor.checked = !!m.useCatColor;
    mColor.value = (m.colorOverride || "");
    mYt.value = m.yt || "";
    mYtTitle.value = m.ytTitle || "";
    mMemo.value = m.memo || "";

    mR.value = String(m.r ?? 10);
    mRNum.value = String(m.r ?? 10);

    mFS.value = String(m.fs ?? 15);
    mFSNum.value = String(m.fs ?? 15);

    mFW.value = String(m.fw ?? 900);
    mLabelColor.value = m.labelColor || (S.markerLabelDefault || "#e7eef8");

    // auto sync logic:
    autoYtTitle = (!m.ytTitle || m.ytTitle === m.name);
    autoMemo = (!m.memo || m.memo === m.name);

    mPos.textContent = `${(m.x||0).toFixed(6)}, ${(m.y||0).toFixed(6)}`;

    updateColorPreview();

    editOverlay.classList.add("show");
    editOverlay.setAttribute("aria-hidden","false");
    mName.focus();
  }

  function closeEdit(){
    editOverlay.classList.remove("show");
    editOverlay.setAttribute("aria-hidden","true");
    editingId = null;
  }

  btnCloseEdit.addEventListener("click", closeEdit);
  editOverlay.addEventListener("click", (e)=>{
    if(e.target === editOverlay) closeEdit();
  });

  // Enter = save (as requested)
  window.addEventListener("keydown", (e)=>{
    if(!editOverlay.classList.contains("show")) return;
    if(e.key==="Escape"){ closeEdit(); return; }
    if(e.key==="Enter"){
      // allow enter in textarea without saving? (ìš”ì²­ìƒ Enter=ì €ì¥)
      e.preventDefault();
      doSave();
    }
  });

  function updateColorPreview(){
    const m = S.markers.find(x=>x.id===editingId);
    if(!m) return;
    const temp = {
      ...m,
      cat: mCat.value,
      useCatColor: mUseCatColor.checked,
      colorOverride: (mColor.value||"").trim()
    };
    mColorPreview.style.background = markerColor(temp);
  }

  mUseCatColor.addEventListener("change", updateColorPreview);
  mColor.addEventListener("input", updateColorPreview);
  mCat.addEventListener("change", updateColorPreview);

  // Name sync rules:
  // - name ì…ë ¥í•˜ë©´ ytTitle/memoë„ ê°™ì´ ì±„ì›€(ë‹¨, ì‚¬ìš©ìê°€ ë”°ë¡œ ìˆ˜ì •í•œ ì  ì—†ëŠ” ê²½ìš°ë§Œ)
  mName.addEventListener("input", ()=>{
    const v = mName.value;
    if(autoYtTitle) mYtTitle.value = v;
    if(autoMemo) mMemo.value = v;
  });
  mYtTitle.addEventListener("input", ()=>{ autoYtTitle = false; });
  mMemo.addEventListener("input", ()=>{ autoMemo = false; });

  // size sync: r drives fs
  function syncRToFS(){
    const r = Number(mR.value||10);
    mRNum.value = String(r);
    // ë¹„ìœ¨: r=10 -> fs=15
    const fs = Math.round(clamp(r * 1.5, 10, 26));
    mFS.value = String(fs);
    mFSNum.value = String(fs);
  }
  mR.addEventListener("input", syncRToFS);
  mRNum.addEventListener("input", ()=>{
    const v = clamp(Number(mRNum.value||10), 4, 30);
    mR.value = String(v);
    syncRToFS();
  });
  mFS.addEventListener("input", ()=>{
    const v = clamp(Number(mFS.value||15), 10, 26);
    mFSNum.value = String(v);
  });
  mFSNum.addEventListener("input", ()=>{
    const v = clamp(Number(mFSNum.value||15), 10, 26);
    mFS.value = String(v);
  });

  btnLabelDefault.addEventListener("click", ()=>{
    mLabelColor.value = S.markerLabelDefault || "#e7eef8";
  });

  // Quick colors
  const quickMarkerColors = [
    "#ff5d5d","#ff8a00","#ffd60a","#39d98a","#2b8cff","#ffffff","#000000"
  ];
  const quickLabelColors = [
    "#ff5d5d","#ff8a00","#ffd60a","#39d98a","#2b8cff","#ffffff"
  ];
  function renderQuickColors(){
    const qm = $("quickMarkerColors");
    const ql = $("quickLabelColors");
    qm.innerHTML = "";
    ql.innerHTML = "";
    for(const c of quickMarkerColors){
      const b = document.createElement("div");
      b.className = "swatch";
      b.title = c;
      b.innerHTML = `<div style="background:${c};"></div>`;
      b.addEventListener("click", ()=>{
        mUseCatColor.checked = false;
        mColor.value = c;
        updateColorPreview();
      });
      qm.appendChild(b);
    }
    for(const c of quickLabelColors){
      const b = document.createElement("div");
      b.className = "swatch";
      b.title = c;
      b.innerHTML = `<div style="background:${c};"></div>`;
      b.addEventListener("click", ()=>{
        mLabelColor.value = c;
      });
      ql.appendChild(b);
    }
  }
  renderQuickColors();

  function doSave(){
    const m = S.markers.find(x=>x.id===editingId);
    if(!m) return;

    m.name = (mName.value||"").trim();
    m.cat = mCat.value;

    m.useCatColor = !!mUseCatColor.checked;
    m.colorOverride = (mColor.value||"").trim();

    m.yt = (mYt.value||"").trim();
    m.ytTitle = (mYtTitle.value||"").trim();
    m.memo = (mMemo.value||"").trim();

    m.r = clamp(Number(mR.value||10), 4, 30);
    m.fs = clamp(Number(mFS.value||15), 10, 26);
    m.fw = clamp(Number(mFW.value||900), 600, 900);
    m.labelColor = (mLabelColor.value||"").trim() || (S.markerLabelDefault || "#e7eef8");

    saveState();
    renderKPIs();
    draw();
    toast("ì €ì¥ ì™„ë£Œ");
    closeEdit();
  }

  btnSave.addEventListener("click", doSave);

  btnDelete.addEventListener("click", ()=>{
    const m = S.markers.find(x=>x.id===editingId);
    if(!m) return;
    if(!confirm("ì´ ë§ˆì»¤ë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;
    S.markers = S.markers.filter(x=>x.id!==editingId);
    saveState();
    closeEdit();
    clearSelection();
    renderKPIs();
    draw();
    toast("ì‚­ì œ ì™„ë£Œ");
  });

  /******************************************************************
   * INIT
   ******************************************************************/
  renderPages();
  renderCats();
  renderEditCatOptions();

  // load map & canvas
  resizeCanvas();
  loadMap();
  if(!S.map.scale || S.map.scale<=0){
    // fit after map load; if placeholder, still fits
    setTimeout(()=>{
      fitToScreen();
      saveState();
      draw();
    }, 0);
  }else{
    draw();
  }
  renderKPIs();

})();
</script>
</body>
</html>
