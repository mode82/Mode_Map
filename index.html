<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Interactive Multi-Map Demo v7.0.0</title>
  <style>
    :root{
      color-scheme: dark;
      --bg:#070b12;
      --panel:#0b1220cc;
      --card:#0e1626cc;
      --stroke:#1f2a3a;
      --stroke2:#27344a;
      --text:#e7eef8;
      --muted:#9fb0c6;
      --accent:#7cc4ff;
      --danger:#ff5d5d;
      --ok:#39d98a;
      --warn:#ffd60a;
      --r14:14px;
      --r16:16px;
      --r18:18px;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --shadow2: 0 8px 24px rgba(0,0,0,.35);
      --blur: 14px;
      --topSlotW: 150px;
      --topSlotH: 38px;
    }

    *{ box-sizing:border-box; }

    /* 화면에서 지도 및 페이지 이동 */
    html, body{ 
      width:100%; max-width:100%; overflow-x:hidden; 
      overscroll-behavior-x: none; overscroll-behavior-y: none; 
      touch-action: manipulation; 
    }

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(1200px 800px at 15% 10%, rgba(124,196,255,.14), transparent 55%),
        radial-gradient(900px 700px at 85% 15%, rgba(167,139,250,.14), transparent 55%),
        radial-gradient(1000px 900px at 60% 90%, rgba(57,217,138,.10), transparent 60%),
        linear-gradient(180deg, var(--bg), #050812 70%);
      color: var(--text);
    }

    /* 지도에 대한 스타일 */
    #canvas{ width:100%; height:100%; display:block; background:#0b0f14; touch-action:none; }
    .center{ position:relative; overflow:hidden; }

    /* 지도 조작 및 고정 로고 */
    #logoSlot{ padding: 0; justify-content: center; border: 0; }
    #logoImg{ width:100%; height:100%; object-fit: contain; display:none; padding:4px; }
    #logoUploadBtn{ position:absolute; inset:0; border:0; background: transparent; cursor:pointer; font-weight:900; color: rgba(231,238,248,.88); display:none; }
    #logoUploadBtn:hover{ box-shadow: 0 0 0 3px rgba(124,196,255,.10) inset; }

    /* 마커 텍스트 투명도 문제 수정 */
    .marker-text { opacity: 1 !important; }

    /* 모바일에서 지도 스크롤 제한 및 확대/축소 */
    #centerStage{ touch-action:none; overscroll-behavior: none; }

    .wrap{ display:grid; grid-template-columns: 380px 1fr 380px; height: calc(100vh - 56px); }
    .panel{ background: rgba(8,12,20,.55); backdrop-filter: blur(var(--blur)); overflow:auto; padding:14px; }
    .panel.left{ border-right:1px solid rgba(31,42,58,.85); }
    .panel.right{ border-left:1px solid rgba(31,42,58,.85); }

    /* 마커 불투명화, 모바일에서 불투명화 기능 */
    .dimmed { opacity: 0.30 !important; }
  </style>
</head>
<body>

<header>
  <!-- 카테고리 1~4 슬롯 -->
  <div class="topSlots" id="topSlots">
    <div class="topSlot" id="logoSlot" title="로고 자리 (카테고리1)">
      <img id="logoImg" alt="logo" />
      <button id="logoUploadBtn" class="adminOnly" type="button">로고 URL</button>
    </div>
  </div>

  <!-- 관리자 모드 토글 -->
  <span class="pill" id="adminToggleWrap">
    <span class="badge" id="modeBadge">USER</span>
    <label class="muted" style="margin:0;">관리자</label>
    <input id="adminToggle" type="checkbox" />
  </span>
</header>

<div class="wrap">
  <!-- 좌측: 페이지 -->
  <aside class="panel left">
    <div class="section">
      <h3>페이지</h3>
      <div id="pageList" style="display:flex; flex-direction:column; gap:10px;"></div>
    </div>
  </aside>

  <!-- 지도 중심 -->
  <div class="center" id="centerStage">
    <canvas id="canvas"></canvas>
  </div>

  <!-- 우측: 마커 및 툴 -->
  <aside class="panel right">
    <div class="section" id="categorySection">
      <h3>카테고리</h3>
      <div class="catGrid" id="categoryBar"></div>
      <div class="muted" id="countInfo" style="margin-top:10px;">-</div>
    </div>
    <div class="section" id="userResetSection">
      <button id="resetDimBtn" class="smallBtn resetDanger" style="width:100%;">마커 초기화</button>
    </div>
  </aside>
</div>

<script>
(() => {
  // ========================================================== 
  // 1. 지도 좌클릭 상태에서 이동 기능
  let isPanning = false;
  let panStart = { x: 0, y: 0 };
  let viewStart = { ox: 0, oy: 0 };
  
  // 지도 드래그 및 이동
  canvas.addEventListener("mousedown", (evt) => {
    const { x:sx, y:sy } = getPointerPos(evt);
    if(evt.button !== 0) return;
    if(!state.ui.admin) {
      isPanning = true;
      panStart = { x:sx, y:sy };
      viewStart = { ox:view.offsetX, oy:view.offsetY };
    }
  });

  canvas.addEventListener("mousemove", (evt) => {
    if(isPanning){
      const { x:sx, y:sy } = getPointerPos(evt);
      const dx = sx - panStart.x;
      const dy = sy - panStart.y;
      view.offsetX = viewStart.ox + dx;
      view.offsetY = viewStart.oy + dy;
      clampViewToBounds();
      draw();
    }
  });

  // ========================================================== 
  // 2. 마커 클릭 시 텍스트 불투명화 문제 수정
  function renderMarkers(){
    const markers = getVisibleMarkers();
    markers.forEach(marker => {
      const isDimmed = state.ui.dimmedMarkerIds.includes(marker.id);
      ctx.save();
      ctx.globalAlpha = isDimmed ? 0.30 : 1.0;
      // 마커 그리기
      ctx.beginPath();
      ctx.arc(marker.x, marker.y, marker.radius, 0, Math.PI * 2);
      ctx.fillStyle = marker.color || "#ffffff";
      ctx.fill();
      ctx.restore();
    });
  }

  // ========================================================== 
  // 3. 모바일에서 마커 불투명화 기능
  function toggleMarkerDim(markerId) {
    if (state.ui.dimmedMarkerIds.includes(markerId)) {
      state.ui.dimmedMarkerIds = state.ui.dimmedMarkerIds.filter(id => id !== markerId);
    } else {
      state.ui.dimmedMarkerIds.push(markerId);
    }
    saveState();
    draw();
  }

  // ========================================================== 
  // 4. 모바일에서 로고 보이기
  function loadLogo() {
    const logoUrl = localStorage.getItem("mm_logo_url_v1");
    const logoImage = document.getElementById("logoImg");
    if (logoUrl) {
      logoImage.src = logoUrl;
      logoImage.style.display = "block";
    }
  }

  // Initialize the map with logos and other features
  window.addEventListener("load", () => {
    loadLogo();
    // Other initialization...
  });
})();
</script>
</body>
</html>
