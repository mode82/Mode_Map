<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Interactive Multi-Map Demo v7.0.0</title>

  <style>
    :root{
      color-scheme: dark;

      --bg:#070b12;
      --panel:#0b1220cc;
      --card:#0e1626cc;
      --stroke:#1f2a3a;
      --stroke2:#27344a;
      --text:#e7eef8;
      --muted:#9fb0c6;
      --accent:#7cc4ff;
      --danger:#ff5d5d;
      --ok:#39d98a;
      --warn:#ffd60a;

      --r14:14px;
      --r16:16px;
      --r18:18px;

      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --shadow2: 0 8px 24px rgba(0,0,0,.35);
      --blur: 14px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(124,196,255,.14), transparent 55%),
        radial-gradient(900px 700px at 85% 15%, rgba(167,139,250,.14), transparent 55%),
        radial-gradient(1000px 900px at 60% 90%, rgba(57,217,138,.10), transparent 60%),
        linear-gradient(180deg, var(--bg), #050812 70%);
      color: var(--text);
    }
    a{ color: var(--accent); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    header{
      display:flex; gap:10px; align-items:center;
      padding:10px 12px;
      position:sticky; top:0; z-index:10;
      background: rgba(6,10,18,.72);
      border-bottom: 1px solid rgba(31,42,58,.9);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
    }

    button, input, select, textarea{
      background: rgba(16,24,38,.65);
      border: 1px solid rgba(39,52,74,.9);
      color: var(--text);
      border-radius: var(--r14);
      padding:9px 11px;
      font-size:14px;
      outline:none;
      transition: transform .08s ease, border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }
    button{ cursor:pointer; font-weight:800; }
    button:hover{ border-color: rgba(124,196,255,.55); box-shadow: 0 0 0 3px rgba(124,196,255,.12); }
    button:active{ transform: translateY(1px); }
    button:disabled{ opacity:.45; cursor:not-allowed; transform:none; box-shadow:none; }
    input:focus, select:focus, textarea:focus, button:focus-visible{
      border-color: rgba(124,196,255,.8);
      box-shadow: 0 0 0 4px rgba(124,196,255,.14);
    }

    .ghost{ background: rgba(9,14,24,.55); }
    .ok{ border-color: rgba(57,217,138,.65) !important; background: rgba(10,22,16,.55) !important; }
    .danger{ border-color: rgba(255,93,93,.55) !important; background: rgba(26,10,12,.55) !important; }
    .warn{ border-color: rgba(255,214,10,.55) !important; background: rgba(22,18,10,.55) !important; }

    .pill{
      display:inline-flex; align-items:center; gap:10px;
      padding:8px 10px;
      border:1px solid rgba(39,52,74,.9);
      border-radius:999px;
      background: rgba(14,22,38,.55);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .badge{
      display:inline-block;
      font-size:12px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.9);
      background: rgba(8,12,20,.6);
    }
    .badge.ok{ border-color: rgba(57,217,138,.6); background: rgba(10,22,16,.55); }
    .muted{ color: var(--muted); font-size:12px; }
    .k{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
    }

    .wrap{ display:grid; grid-template-columns: 380px 1fr 380px; height: calc(100vh - 56px); }
    .panel{
      background: rgba(8,12,20,.55);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      overflow:auto;
      padding:14px;
    }
    .panel.left{ border-right:1px solid rgba(31,42,58,.85); }
    .panel.right{ border-left:1px solid rgba(31,42,58,.85); }
    .center{ position:relative; overflow:hidden; }
    #canvas{ width:100%; height:100%; display:block; background:#0b0f14; }

    .section{
      border:1px solid rgba(31,42,58,.9);
      border-radius: var(--r18);
      padding:14px;
      margin-bottom:12px;
      background: linear-gradient(180deg, rgba(14,22,38,.72), rgba(10,16,28,.58));
      box-shadow: var(--shadow2);
    }
    .section h3{
      margin:0 0 10px;
      font-size:13px;
      letter-spacing:.3px;
      color: rgba(231,238,248,.92);
      display:flex; align-items:center; gap:8px;
    }
    .row{ display:flex; gap:8px; margin:8px 0; }
    .row > *{ flex:1; }
    .hr{ height:1px; background: rgba(31,42,58,.9); margin:12px 0; }

    .catGrid{ display:flex; flex-wrap:wrap; gap:8px; }
    .catBtn{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.9);
      background: rgba(8,12,20,.55);
      font-size:12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .catDot{ width:10px; height:10px; border-radius:999px; border:1px solid rgba(39,52,74,.9); display:inline-block; }
    .catBtn.active{ border-color: rgba(124,196,255,.9); box-shadow: 0 0 0 3px rgba(124,196,255,.14); }

    .palette{ display:flex; flex-wrap:wrap; gap:10px; }
    .swatchWrap{ display:flex; flex-direction:column; align-items:center; gap:4px; }
    .swatch{
      width:36px; height:36px;
      border-radius:12px;
      border:1px solid rgba(39,52,74,.9);
      display:inline-flex; align-items:center; justify-content:center;
      background: rgba(8,12,20,.55);
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
    }
    .swatch button{
      width:28px; height:28px;
      border-radius:10px;
      border:1px solid rgba(39,52,74,.9);
      padding:0;
      background:transparent;
    }
    .swatch.active{ outline:2px solid rgba(124,196,255,.9); outline-offset:2px; }
    .swatchLabel{ font-size:11px; color: var(--muted); }

    .smallBtn{ padding:9px 11px; font-size:13px; }
    .linkBox{
      padding:12px 12px;
      border:1px solid rgba(39,52,74,.9);
      border-radius: var(--r16);
      background: rgba(8,12,20,.55);
      word-break:break-all;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
    }

    /* Hover overlay (user mode) */
    #hoverOverlay{
      position:absolute;
      display:none;
      z-index:50;
      background: rgba(10,16,28,.78);
      border: 1px solid rgba(124,196,255,.18);
      border-radius: var(--r16);
      padding:10px 12px;
      max-width:min(420px, 84vw);
      box-shadow: var(--shadow);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      pointer-events:auto;
    }
    #hoverOverlay .memoLabel{
      font-size:12px;
      color: var(--muted);
      margin-bottom:6px;
      font-weight:800;
      letter-spacing:.2px;
    }
    #hoverOverlay textarea{
      width: 100%;
      resize:none;
      line-height:1.35;
      padding:10px 10px;
      border-radius:12px;
      margin-bottom:10px;
      font-size:13px;
    }
    #hoverOverlay textarea[readonly]{ opacity: .95; }
    #hoverOverlay .yt{ font-size:14px; font-weight:900; letter-spacing:.2px; }
    #hoverOverlay .yt a{ color: rgba(231,238,248,.95); text-decoration:none; }
    #hoverOverlay .yt a:hover{ text-decoration: underline; }

    /* Modals */
    .modalBackdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:16px;
      z-index:999;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .modal{
      width:min(860px, 100%);
      border:1px solid rgba(39,52,74,.95);
      border-radius: var(--r18);
      background: linear-gradient(180deg, rgba(14,22,38,.92), rgba(10,16,28,.88));
      box-shadow: var(--shadow);
      overflow:hidden;
      max-height: min(86vh, 980px);
      display:flex;
      flex-direction:column;
    }
    .modalHeader{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px;
      border-bottom:1px solid rgba(31,42,58,.9);
      background: rgba(8,12,20,.35);
      flex:0 0 auto;
    }
    .modalHeader b{ font-size:14px; letter-spacing:.2px; }
    .modalBody{ padding:12px 14px; overflow:auto; flex: 1 1 auto; }
    .modalBody label{ display:block; font-size:12px; color: var(--muted); margin:10px 0 6px; }
    .modalFooter{
      display:flex; gap:8px;
      padding:12px 14px;
      border-top:1px solid rgba(31,42,58,.9);
      justify-content:flex-end;
      background: rgba(8,12,20,.25);
      flex:0 0 auto;
      flex-wrap:wrap;
      align-items:center;
    }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }

    @media (max-width: 1100px){
      .wrap{ grid-template-columns: 1fr; height:auto; }
      .panel.left{ border-right:none; border-bottom:1px solid rgba(31,42,58,.85); }
      .panel.right{ border-left:none; border-top:1px solid rgba(31,42,58,.85); }
      #canvas{ height: 55vh; }
      .grid2{ grid-template-columns: 1fr; }
    }

    input[type="color"]{
      width:46px; height:38px;
      padding:0; border-radius:12px;
      border:1px solid rgba(39,52,74,.9);
      background: rgba(16,24,38,.65);
    }
    .quickColorRow{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .qc{
      width:30px; height:30px;
      border-radius:10px;
      border:1px solid rgba(39,52,74,.9);
      background: rgba(8,12,20,.55);
      display:inline-flex; align-items:center; justify-content:center;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(0,0,0,.18);
    }
    .qc > i{
      width:20px; height:20px;
      border-radius:8px;
      display:block;
      border:1px solid rgba(39,52,74,.9);
    }
    .styleRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:stretch; }
    .styleCard{
      border:1px solid rgba(39,52,74,.8);
      background: rgba(8,12,20,.35);
      border-radius: var(--r16);
      padding:10px 12px;
      flex: 1 1 240px;
      min-width: 240px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .styleCard .head{ display:flex; align-items:baseline; justify-content:space-between; gap:10px; }
    .styleCard .head .t{ font-weight:900; }
    .styleCard .head .d{ color: var(--muted); font-size:12px; }
    .rangeRow{ display:flex; align-items:center; gap:10px; }
    .rangeRow input[type="range"]{ flex:1; }
    .rangeRow input[type="number"]{ width:86px; }

    /* Reset button (shape baseline) */
    .resetDanger{
      border: 2px solid rgba(255,93,93,.92) !important;
      background: rgba(26,10,12,.45) !important;
      box-shadow: 0 0 0 4px rgba(255,93,93,.10);
    }

    /* Page buttons: keep same size/shape as resetDanger, but different colors */
    .pageBtn{
      width:100%;
      padding:12px 12px;
      border-radius: var(--r16);
      border: 2px solid rgba(124,196,255,.40);
      background: rgba(10,18,30,.45);
      box-shadow: 0 0 0 4px rgba(124,196,255,.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      text-align:left;
    }
    .pageBtn:hover{
      border-color: rgba(124,196,255,.75);
      box-shadow: 0 0 0 4px rgba(124,196,255,.12);
    }
    .pageBtn.active{
      border-color: rgba(57,217,138,.85);
      box-shadow: 0 0 0 4px rgba(57,217,138,.12);
    }
    .pageBtn .name{
      font-weight:900;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pageBtn .meta{
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
      flex:0 0 auto;
    }
    .pageActions{
      display:flex; gap:6px; flex:0 0 auto;
    }
    .iconBtn{
      padding:6px 8px;
      border-radius:12px;
      font-size:12px;
      border:1px solid rgba(39,52,74,.9);
      background: rgba(8,12,20,.45);
    }
    .iconBtn:hover{ border-color: rgba(124,196,255,.55); box-shadow:none; }
    .iconBtn.danger{ border-color: rgba(255,93,93,.55) !important; }

    /* Title dropdown */
    .titleWrap{ position:relative; }
    .titleBtn{
      display:flex; align-items:center; gap:10px;
      font-weight:900; letter-spacing:.2px;
      padding:8px 10px;
      border-radius:14px;
      border:1px solid rgba(39,52,74,.9);
      background: rgba(14,22,38,.55);
      cursor:pointer;
      user-select:none;
    }
    .titleBtn:hover{ border-color: rgba(124,196,255,.55); box-shadow: 0 0 0 3px rgba(124,196,255,.12); }
    .titleBtn .caret{ opacity:.8; }
    .drop{
      position:absolute;
      top: calc(100% + 10px);
      left: 0;
      width: min(420px, 72vw);
      background: rgba(10,16,28,.90);
      border:1px solid rgba(39,52,74,.95);
      border-radius: 16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      padding:10px;
      display:none;
      z-index:999;
    }
    .drop .item{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(39,52,74,.75);
      background: rgba(8,12,20,.35);
      margin-bottom:8px;
    }
    .drop .item:last-child{ margin-bottom:0; }
    .drop .item .left{ min-width:0; }
    .drop .item .gname{
      font-weight:900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .drop .item .gmeta{
      font-size:12px;
      color: var(--muted);
      margin-top:4px;
    }

    /* Admin Lock Overlay (only on admin82.html) */
    #__adminLockOverlay{
      position: fixed; inset: 0;
      display: none;
      align-items: center; justify-content: center;
      background: rgba(0,0,0,.78);
      backdrop-filter: blur(6px);
      z-index: 2147483647;
    }
    #__adminLockCard{
      width: min(420px, calc(100vw - 32px));
      background: rgba(20, 24, 36, .92);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 16px;
      padding: 18px 18px 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,.5);
      color: #fff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    #__adminLockCard h2{ margin: 0 0 8px; font-size: 18px; }
    #__adminLockCard p{ margin: 0 0 14px; opacity: .85; font-size: 13px; line-height: 1.4; }
    #__adminPw{
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.25);
      color: #fff;
      outline: none;
    }
    #__adminLockRow{ display:flex; gap:10px; margin-top:12px; }
    #__adminUnlockBtn{
      flex: 1;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(124,196,255,.18);
      color: #fff;
      cursor: pointer;
      font-weight: 700;
    }
    #__adminUnlockBtn:active{ transform: translateY(1px); }
    #__adminLockMsg{ margin-top: 10px; font-size: 12px; opacity: .9; min-height: 16px; }
    #__adminLogoutBtn{
      position: fixed;
      right: 12px; bottom: 12px;
      z-index: 2147483646;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,80,80,.18);
      color: #fff;
      cursor: pointer;
      font-size: 12px;
      display: none;
    }
  </style>
</head>

<body>
<header>
  <!-- ✅ MAP DEMO = 게임 이름 자리 + 클릭 시 드롭다운 (항상 표시) -->
  <div class="titleWrap" id="titleWrap">
    <div class="titleBtn" id="gameTitleBtn" title="클릭해서 게임 목록/추가">
      <span id="gameTitleText">Map Demo</span>
      <span class="muted caret">▾</span>
    </div>
    <div class="drop" id="gameDrop"></div>
  </div>

  <!-- ✅ 관리자 모드 토글(유저 페이지에서는 숨김 처리됨) -->
  <span class="pill" id="adminToggleWrap">
    <span class="badge" id="modeBadge">USER</span>
    <label class="muted" style="margin:0;">관리자</label>
    <input id="adminToggle" type="checkbox" />
  </span>

  <!-- ✅ 상단 메뉴: 관리자 모드에서만 -->
  <button id="uploadBtn" class="adminOnly">지도 업로드</button>
  <button id="resetViewBtn" class="adminOnly">뷰 리셋</button>
  <button id="clearAllBtn" class="danger adminOnly">전체 초기화</button>
  <input id="fileInput" type="file" accept="image/*" style="display:none;" />
</header>

<div class="wrap">
  <!-- ✅ 좌측: 페이지 -->
  <aside class="panel left">
    <div class="section">
      <h3>
        페이지
        <span class="badge" id="pageBadge" style="margin-left:auto;">-</span>
      </h3>

      <!-- 관리자 모드에서만 보이는 +페이지추가 -->
      <button id="addPageBtn" class="pageBtn adminOnly" style="justify-content:center;">
        <span class="name">+ 페이지 추가</span>
      </button>

      <!-- ✅ 안내 문구는 관리자에서만 보이게 -->
      <div class="muted adminOnly" style="margin:10px 0 8px; line-height:1.4;">
        • 페이지 버튼 클릭 → 같은 게임 안에서 지도 페이지 이동<br/>
        • <b>폰/다른 기기</b>에서도 지도 보이게 하려면: 관리자에서 <b>URL</b> 버튼으로 지도 이미지 URL 설정
      </div>

      <div id="pageList" style="display:flex; flex-direction:column; gap:10px;"></div>
    </div>
  </aside>

  <div class="center" id="centerStage">
    <canvas id="canvas"></canvas>

    <!-- 유저모드: 텍스트에 hover/click 했을 때만 표시 -->
    <div id="hoverOverlay">
      <div class="memoLabel">메모</div>
      <textarea id="hoverMemo" cols="10" rows="3" placeholder="" readonly></textarea>
      <div class="yt" id="hoverYt">-</div>
    </div>
  </div>

  <!-- ✅ 우측 -->
  <aside class="panel right">
    <div class="section" id="categorySection">
      <h3>카테고리</h3>
      <div class="catGrid" id="categoryBar"></div>
      <div class="muted" id="countInfo" style="margin-top:10px;">-</div>
      <div class="row adminOnly" id="adminCategoryTools" style="margin-top:10px;">
        <button id="editCategoriesBtn">카테고리/색상 편집</button>
      </div>
    </div>

    <div class="section adminOnly" id="adminToolsSection">
      <h3>관리자 툴</h3>
      <div class="muted" style="line-height:1.45;">
        • 색상 팔레트(체인 1번 기준 전파)<br/>
        • 선은 “같은 카테고리 필터” 시 같이 표시/숨김
      </div>

      <div class="hr"></div>
      <div class="muted">빠른 색상 (원 색상 오버라이드)</div>
      <div class="palette" id="paletteBar" style="margin-top:8px;"></div>
      <div class="row">
        <button id="applyPaletteToSelectedBtn" class="smallBtn" disabled>선택 마커에 적용</button>
        <button id="clearOverrideBtn" class="smallBtn ghost" disabled>선택 마커 색상(카테고리로)</button>
      </div>

      <div class="hr"></div>
      <div class="row">
        <button id="removeAllLinksBtn" class="smallBtn danger">모든 선 제거</button>
        <button id="resetChainBtn" class="smallBtn ghost">선 다시 체인(전체)</button>
      </div>

      <div class="hr"></div>
      <div class="muted" style="line-height:1.45;">
        • 현재 우클릭 기본 카테고리: <span class="k" id="createCategoryHint">-</span>
      </div>
      <div class="muted" style="line-height:1.45; margin-top:6px;">
        • 현재 "이어붙이기 기준": <span class="k" id="insertAfterHint">없음</span>
      </div>
    </div>

    <!-- 유저모드: 마커 초기화 -->
    <div class="section" id="userResetSection">
      <button id="resetDimBtn" class="smallBtn resetDanger" style="width:100%;">마커 초기화</button>
    </div>

    <div class="section" id="selectedSection">
      <h3 id="selectedHeader">선택한 마커</h3>
      <div class="hr"></div>
      <div class="muted">유튜브</div>
      <div id="youtubeBox" class="linkBox" style="margin-top:8px;">-</div>
    </div>
  </aside>
</div>

<!-- Marker Edit Modal -->
<div class="modalBackdrop" id="markerModalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="markerModalTitle">
    <div class="modalHeader">
      <b id="markerModalTitle">마커 편집</b>
      <button id="closeMarkerModalBtn">닫기</button>
    </div>
    <div class="modalBody">
      <div class="muted">관리자 모드에서만 편집/삭제 가능합니다. (Enter = 저장)</div>

      <div class="grid2" style="margin-top:12px;">
        <div>
          <label>이름(마커 이름)</label>
          <input id="modalTitle" placeholder="예: 깃털 위치" />
        </div>
        <div>
          <label>카테고리</label>
          <select id="modalCategory"></select>
        </div>
      </div>

      <label style="margin-top:14px;">마커 원 색상</label>
      <div class="miniLine" style="display:flex; align-items:center; justify-content:space-between; gap:10px;
           border:1px solid rgba(39,52,74,.8); background: rgba(8,12,20,.35); border-radius: var(--r16); padding:10px 12px;">
        <div class="muted">개별 오버라이드 색상</div>
        <div style="display:flex; align-items:center; gap:10px;">
          <input id="modalColor" type="color" />
          <label class="muted" style="display:flex; align-items:center; gap:8px; margin:0;">
            <input id="modalUseCategoryColor" type="checkbox" style="width:18px; height:18px;" />
            카테고리 색상 사용
          </label>
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid2">
        <div>
          <label>유튜브 링크(URL)</label>
          <input id="modalYoutubeUrl" placeholder="https://www.youtube.com/watch?v=..." />
        </div>
        <div>
          <label>유튜브 표시명(유저모드 제목)</label>
          <input id="modalYoutubeLabel" placeholder="예: 깃털 1번위치" />
        </div>
      </div>

      <div class="hr"></div>

      <label>메모 (관리자 등록)</label>
      <textarea id="modalMemo" rows="5" placeholder="관리자 메모를 입력하세요. 유저모드에서는 읽기 전용입니다."></textarea>

      <div class="hr"></div>

      <h3 style="margin:0 0 8px; font-size:13px; letter-spacing:.3px;">마커 스타일</h3>
      <div class="styleRow">
        <div class="styleCard">
          <div class="head">
            <div class="t">원 크기</div>
            <div class="d">px</div>
          </div>
          <div class="rangeRow">
            <input id="modalRadiusRange" type="range" min="6" max="30" step="1" />
            <input id="modalRadius" type="number" min="6" max="30" step="1" />
          </div>
          <div class="muted">* 원 크기 변경 시 글씨 크기가 같은 비율로 자동 변경됩니다.</div>
        </div>

        <div class="styleCard">
          <div class="head">
            <div class="t">글씨 크기</div>
            <div class="d">라벨</div>
          </div>
          <div class="rangeRow">
            <input id="modalFontSizeRange" type="range" min="10" max="48" step="1" />
            <input id="modalFontSize" type="number" min="10" max="48" step="1" />
          </div>
          <div class="muted">* 현재는 자동 동기화 우선</div>
        </div>

        <div class="styleCard">
          <div class="head">
            <div class="t">굵기/색상</div>
            <div class="d">라벨</div>
          </div>
          <select id="modalFontWeight">
            <option value="400">400 (Regular)</option>
            <option value="600">600 (SemiBold)</option>
            <option value="800">800 (ExtraBold)</option>
            <option value="900">900 (Black)</option>
          </select>

          <div style="margin-top:6px;">
            <div class="muted" style="margin-bottom:6px;">글씨 색상 (라벨)</div>
            <div style="display:flex; align-items:center; gap:10px;">
              <input id="modalFontColor" type="color" />
              <button id="modalFontColorResetBtn" class="smallBtn ghost" type="button">기본값</button>
            </div>

            <div class="muted" style="margin-top:10px;">빠른 글씨색</div>
            <div class="quickColorRow" id="modalFontColorQuick"></div>
          </div>
        </div>
      </div>

      <div class="muted" style="margin-top:10px;">
        좌표(비율): <span class="k" id="modalCoord">-</span>
      </div>

      <div class="hr"></div>
      <div class="muted" style="line-height:1.55;">
        • <b>새로운 번호로 시작</b>: 이 마커부터 새 체인(새 1번) 시작<br/>
        • <b>해당 마커를 이어서 시작</b>: 이 마커 뒤로 “중간 삽입” 모드 활성화
      </div>
    </div>

    <div class="modalFooter">
      <button id="startNewGroupFromHereBtn" class="warn" type="button">새로운 번호로 시작</button>
      <button id="continueNumberingFromHereBtn" class="warn" type="button">해당 마커를 이어서 시작</button>
      <span style="flex:1 1 auto;"></span>
      <button id="deleteMarkerBtn" class="danger">삭제</button>
      <button id="saveMarkerBtn" class="ok">저장</button>
    </div>
  </div>
</div>

<!-- Category Edit Modal -->
<div class="modalBackdrop" id="catModalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="catModalTitle">
    <div class="modalHeader">
      <b id="catModalTitle">카테고리/색상 편집</b>
      <button id="closeCatModalBtn">닫기</button>
    </div>

    <div class="modalBody">
      <div class="muted">저장하면 현재 게임의 카테고리 목록이 완전히 교체됩니다.</div>
      <div class="hr"></div>

      <div class="muted">빠른 색상 (선택한 카테고리 행에 적용)</div>
      <div class="palette" id="catPaletteBar" style="margin-top:8px;"></div>
      <div class="muted" id="catPaletteHint" style="margin-top:8px;">카테고리 행을 먼저 클릭해서 선택하세요.</div>

      <div class="hr"></div>

      <div class="row" style="margin-top:12px;">
        <button id="addCategoryRowBtn" class="smallBtn">+ 카테고리 추가</button>
        <button id="resetCategoriesBtn" class="smallBtn ghost">기본값으로</button>
      </div>

      <div id="catEditorList" style="margin-top:10px; display:flex; flex-direction:column; gap:10px;"></div>
    </div>

    <div class="modalFooter">
      <button id="saveCatListBtn" class="ok">저장</button>
    </div>
  </div>
</div>

<!-- Admin Lock UI (only on admin82.html) -->
<div id="__adminLockOverlay">
  <div id="__adminLockCard">
    <h2>관리자 인증</h2>
    <p>비밀번호를 입력하면 이 브라우저에서 24시간 동안 인증이 유지됩니다.</p>
    <input id="__adminPw" type="password" inputmode="numeric" autocomplete="current-password" placeholder="관리자 비밀번호" />
    <div id="__adminLockRow">
      <button id="__adminUnlockBtn" type="button">확인</button>
    </div>
    <div id="__adminLockMsg"></div>
  </div>
</div>
<button id="__adminLogoutBtn" type="button">관리자 로그아웃</button>

<!-- ✅ iOS 폴리필: structuredClone 없으면 흰 화면 방지 -->
<script>
if (typeof structuredClone !== "function") {
  window.structuredClone = (obj) => JSON.parse(JSON.stringify(obj));
}
</script>

<script>
(() => {
  // ==========================================================
  // Page mode detect
  // ==========================================================
  const IS_ADMIN_PAGE = /admin82\.html$/i.test(location.pathname);
  const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

  // ==========================================================
  // Admin Auth (24h) - only admin page
  // ==========================================================
  const ADMIN_PASSWORD = "0000000001";
  const AUTH_KEY = "mm_admin_auth_v1";
  const SESSION_MS = 24 * 60 * 60 * 1000;

  const $lock = document.getElementById("__adminLockOverlay");
  const $pw = document.getElementById("__adminPw");
  const $unlock = document.getElementById("__adminUnlockBtn");
  const $msg = document.getElementById("__adminLockMsg");
  const $logout = document.getElementById("__adminLogoutBtn");

  function getAuth(){
    try{
      const raw = localStorage.getItem(AUTH_KEY);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(!obj || typeof obj.exp !== "number") return null;
      return obj;
    }catch{ return null; }
  }
  function isAuthed(){
    const a = getAuth();
    return !!(a && a.exp > Date.now());
  }
  function setAuthed(){
    localStorage.setItem(AUTH_KEY, JSON.stringify({ exp: Date.now() + SESSION_MS }));
  }
  function clearAuthed(){
    localStorage.removeItem(AUTH_KEY);
  }

  function showLock(show){
    if(!IS_ADMIN_PAGE) return;
    $lock.style.display = show ? "flex" : "none";
    $logout.style.display = show ? "none" : "block";
    if(show) setTimeout(()=> $pw.focus(), 50);
  }

  // ==========================================================
  // Storage / DB
  // ==========================================================
  const LS_KEY = "imgmap_multi_v700";
  const IDB_NAME = "imgmap_multi_db_v700";
  const IDB_STORE = "blobs";

  function openDB(){
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(IDB_NAME, 1);
      req.onupgradeneeded = () => {
        const db = req.result;
        if(!db.objectStoreNames.contains(IDB_STORE)) db.createObjectStore(IDB_STORE);
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }
  async function idbPut(key, blob){
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(IDB_STORE, "readwrite");
      tx.objectStore(IDB_STORE).put(blob, key);
      tx.oncomplete = () => { db.close(); resolve(true); };
      tx.onerror = () => { db.close(); reject(tx.error); };
    });
  }
  async function idbGet(key){
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(IDB_STORE, "readonly");
      const req = tx.objectStore(IDB_STORE).get(key);
      req.onsuccess = () => { db.close(); resolve(req.result || null); };
      req.onerror = () => { db.close(); reject(req.error); };
    });
  }
  async function idbDel(key){
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(IDB_STORE, "readwrite");
      tx.objectStore(IDB_STORE).delete(key);
      tx.oncomplete = () => { db.close(); resolve(true); };
      tx.onerror = () => { db.close(); reject(tx.error); };
    });
  }

  // ==========================================================
  // Utils
  // ==========================================================
  const nowISO = () => new Date().toISOString();
  const clamp = (v,a,b) => Math.max(a, Math.min(b, v));
  const clamp01 = v => clamp(v,0,1);
  const uid = () => Math.random().toString(36).slice(2, 10) + "-" + Date.now().toString(36);

  function safeParse(json, fallback){
    try { return JSON.parse(json); } catch { return fallback; }
  }
  function saveState(){
    try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); } catch(e){ console.warn(e); }
  }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
  function isValidUrl(url){
    try { new URL(url, location.href); return true; } catch { return false; }
  }
  function uniqByName(list){
    const seen = new Set();
    const out = [];
    for(const item of list){
      const n = (item.name||"").trim();
      if(!n) continue;
      const key = n.toLowerCase();
      if(seen.has(key)) continue;
      seen.add(key);
      out.push({ name:n, color: item.color || "#ffffff" });
    }
    return out;
  }
  function msFromIso(iso){ const t = Date.parse(iso); return Number.isFinite(t) ? t : Date.now(); }
  function isoFromMs(ms){ return new Date(ms).toISOString(); }

  // ==========================================================
  // Config
  // ==========================================================
  const DEFAULT_CATEGORIES = [
    { name:"boss",   color:"#ff6b6b" },
    { name:"gather", color:"#ffd43b" },
    { name:"quest",  color:"#66d9e8" },
    { name:"hunt",   color:"#e6edf3" },
  ];
  const PALETTE = [
    { key:"red",    label:"빨", color:"#ff3b30" },
    { key:"orange", label:"주", color:"#ff9500" },
    { key:"yellow", label:"노", color:"#ffd60a" },
    { key:"green",  label:"초", color:"#34c759" },
    { key:"blue",   label:"파", color:"#0a84ff" },
    { key:"white",  label:"흰", color:"#ffffff" },
    { key:"black",  label:"검", color:"#000000" },
  ];

  const DEFAULT_MARKER_RADIUS_PX = 10;
  const DEFAULT_LABEL_COLOR = "#e6edf3";
  const DEFAULT_LABEL_WEIGHT = 900;
  const LABEL_SIZE_RATIO = 1.5;
  const calcLabelSizeFromRadius = (r) => Math.round(r * LABEL_SIZE_RATIO);

  // ==========================================================
  // Data Model
  // ==========================================================
  const defaultState = {
    ui: {
      admin:false,
      selectedCategory:"",
      selectedMarkerId:"",
      lastCreatedMarkerId:"",
      activePaintColor:"",
      createCategory:"",
      createGroupId:0,
      createColorOverride:"",
      insertAfterMarkerId:"",
      dimmedMarkerIds: [],
    },
    currentGameId: "",
    currentPageId: "",
    games: [
      {
        id: uid(),
        name: "Map Demo",
        categories: structuredClone(DEFAULT_CATEGORIES),
        pages: [
          {
            id: uid(),
            name: "1번마을",
            map: { imageKey:"", imageUrl:"", width:2200, height:1400 },
            markers: [],
            links: []
          }
        ]
      }
    ]
  };

  // Load or init
  const loaded = safeParse(localStorage.getItem(LS_KEY) || "", null);
  const state = (loaded && loaded.games && Array.isArray(loaded.games)) ? loaded : structuredClone(defaultState);

  // Normalize
  if(!state.ui) state.ui = structuredClone(defaultState.ui);
  if(!Array.isArray(state.ui.dimmedMarkerIds)) state.ui.dimmedMarkerIds = [];
  if(!Array.isArray(state.games) || state.games.length === 0){
    state.games = structuredClone(defaultState.games);
  }
  for(const g of state.games){
    if(!g.id) g.id = uid();
    if(typeof g.name !== "string") g.name = "Game";
    if(!Array.isArray(g.categories) || g.categories.length === 0) g.categories = structuredClone(DEFAULT_CATEGORIES);
    if(!Array.isArray(g.pages) || g.pages.length === 0){
      g.pages = [{ id: uid(), name:"1번마을", map:{imageKey:"", imageUrl:"", width:2200, height:1400}, markers:[], links:[] }];
    }
    for(const p of g.pages){
      if(!p.id) p.id = uid();
      if(typeof p.name !== "string") p.name = "Page";
      if(!p.map) p.map = { imageKey:"", imageUrl:"", width:2200, height:1400 };
      if(typeof p.map.imageKey !== "string") p.map.imageKey = "";
      if(typeof p.map.imageUrl !== "string") p.map.imageUrl = "";
      if(typeof p.map.width !== "number" || !isFinite(p.map.width)) p.map.width = 2200;
      if(typeof p.map.height !== "number" || !isFinite(p.map.height)) p.map.height = 1400;
      if(!Array.isArray(p.markers)) p.markers = [];
      if(!Array.isArray(p.links)) p.links = [];
    }
  }

  function getGameById(id){ return state.games.find(g => g.id === id) || null; }
  function getCurrentGame(){
    if(!state.currentGameId) state.currentGameId = state.games[0].id;
    const g = getGameById(state.currentGameId);
    if(!g){ state.currentGameId = state.games[0].id; return state.games[0]; }
    return g;
  }
  function getPageById(game, pid){ return game.pages.find(p => p.id === pid) || null; }
  function getCurrentPage(){
    const g = getCurrentGame();
    if(!state.currentPageId) state.currentPageId = g.pages[0].id;
    const p = getPageById(g, state.currentPageId);
    if(!p){ state.currentPageId = g.pages[0].id; return g.pages[0]; }
    return p;
  }

  function currentCategories(){ return getCurrentGame().categories; }
  function currentMarkers(){ return getCurrentPage().markers; }
  function currentLinks(){ return getCurrentPage().links; }
  function currentMap(){ return getCurrentPage().map; }

  function setCurrentGame(gameId){
    const g = getGameById(gameId);
    if(!g) return;
    state.currentGameId = gameId;
    state.currentPageId = g.pages[0]?.id || "";
    state.ui.selectedMarkerId = "";
    state.ui.selectedCategory = "";
    state.ui.insertAfterMarkerId = "";
    state.ui.lastCreatedMarkerId = "";
    state.ui.dimmedMarkerIds = [];
    ensureCreateDefaults();
    saveState();
    refreshAll();
    loadMapImageForCurrentPage();
  }

  function setCurrentPage(pageId){
    const g = getCurrentGame();
    const p = getPageById(g, pageId);
    if(!p) return;
    state.currentPageId = pageId;

    state.ui.selectedMarkerId = "";
    state.ui.insertAfterMarkerId = "";
    state.ui.lastCreatedMarkerId = "";
    state.ui.dimmedMarkerIds = [];

    ensureCreateDefaults();
    saveState();
    refreshAll();
    loadMapImageForCurrentPage();
  }

  // ==========================================================
  // Chain rule helpers (page-local)
  // ==========================================================
  function getCategoryColor(name){
    const c = currentCategories().find(x => x.name === name);
    return c?.color || "#e6edf3";
  }
  function getMarkerColor(m){
    const ov = (m.colorOverride || "").trim();
    return ov ? ov : getCategoryColor(m.category);
  }
  function getMarkerLabel(m){
    const t = (m.title || "").trim();
    return t ? t : (m.category || "").trim();
  }
  function getUserYoutubeDisplay(m){
    const name = (m.youtubeLabel || "").trim();
    if(name) return name;
    const t = (m.title || "").trim();
    if(t) return t;
    return "유튜브";
  }

  function getSortedGroupMarkers(groupId){
    return currentMarkers()
      .filter(x => Number(x.groupId||0) === Number(groupId||0))
      .sort((a,b) => (a.createdAt||"").localeCompare(b.createdAt||""));
  }
  function computeChainsForGroup(groupId){
    const list = getSortedGroupMarkers(groupId);
    const chains = [];
    let chainIndex = -1;
    for(let i=0;i<list.length;i++){
      const m = list[i];
      const isStart = (i===0) || !!m.chainStart;
      if(isStart){
        chainIndex++;
        chains.push({ groupId:Number(groupId||0), chainIndex, masterId:m.id, ids:[m.id] });
      }else{
        if(chainIndex < 0){
          chainIndex = 0;
          chains.push({ groupId:Number(groupId||0), chainIndex, masterId:m.id, ids:[m.id] });
        }else{
          chains[chainIndex].ids.push(m.id);
        }
      }
    }
    return chains;
  }
  function findChainByMarkerId(markerId){
    const m = currentMarkers().find(x => x.id === markerId);
    if(!m) return null;
    const chains = computeChainsForGroup(Number(m.groupId||0));
    for(const ch of chains){
      if(ch.ids.includes(markerId)) return ch;
    }
    return null;
  }
  function applyChainMasterStyleByChain(chain){
    if(!chain) return;
    const master = currentMarkers().find(x => x.id === chain.masterId);
    if(!master) return;

    const style = {
      category: (master.category || "").trim() || (currentCategories()[0]?.name || "default"),
      radiusPx: (typeof master.radiusPx === "number" && isFinite(master.radiusPx)) ? master.radiusPx : DEFAULT_MARKER_RADIUS_PX,
      colorOverride: (master.colorOverride || "").trim(),
      labelWeight: (typeof master.labelWeight === "number" && isFinite(master.labelWeight)) ? master.labelWeight : DEFAULT_LABEL_WEIGHT,
      labelColor: (typeof master.labelColor === "string" ? master.labelColor : DEFAULT_LABEL_COLOR),
    };

    for(const id of chain.ids){
      const m = currentMarkers().find(x => x.id === id);
      if(!m) continue;
      m.category = style.category;
      m.radiusPx = style.radiusPx;
      m.labelSizePx = clamp(calcLabelSizeFromRadius(style.radiusPx), 10, 48);
      m.colorOverride = style.colorOverride;
      m.labelWeight = style.labelWeight;
      m.labelColor = style.labelColor;
    }
  }
  function applyAllChainsInGroup(groupId){
    const chains = computeChainsForGroup(groupId);
    for(const ch of chains) applyChainMasterStyleByChain(ch);
  }
  function normalizeAllChainsCurrentPage(){
    const groups = new Set(currentMarkers().map(m => Number(m.groupId||0)));
    for(const g of groups) applyAllChainsInGroup(g);
  }

  // Links rebuild (page-local)
  function rebuildLinks(){
    const markers = currentMarkers();
    const byGroup = new Map();
    for(const m of markers){
      const g = Number(m.groupId || 0);
      if(!byGroup.has(g)) byGroup.set(g, []);
      byGroup.get(g).push(m);
    }
    const nextLinks = [];
    for(const [g, list] of byGroup.entries()){
      const sorted = [...list].sort((a,b) => (a.createdAt||"").localeCompare(b.createdAt||""));
      let seg = [];
      for(let i=0;i<sorted.length;i++){
        const m = sorted[i];
        const isStart = (i === 0) || !!m.chainStart;
        if(isStart && seg.length){
          for(let k=1;k<seg.length;k++){
            nextLinks.push({ id: uid(), fromId: seg[k-1].id, toId: seg[k].id });
          }
          seg = [];
        }
        seg.push(m);
      }
      if(seg.length){
        for(let k=1;k<seg.length;k++){
          nextLinks.push({ id: uid(), fromId: seg[k-1].id, toId: seg[k].id });
        }
      }
    }
    getCurrentPage().links = nextLinks;
  }

  function getFirstCreatedMarker(){
    const markers = currentMarkers();
    if(markers.length === 0) return null;
    return [...markers].sort((a,b)=> (a.createdAt||"").localeCompare(b.createdAt||""))[0] || null;
  }
  function ensureCreateDefaults(){
    const first = getFirstCreatedMarker();
    if(!state.ui.createCategory){
      state.ui.createCategory = first?.category || (currentCategories()[0]?.name || "default");
    }
    if(typeof state.ui.createGroupId !== "number" || !isFinite(state.ui.createGroupId)){
      state.ui.createGroupId = first?.groupId ?? 0;
    }
  }

  // ==========================================================
  // DOM
  // ==========================================================
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  const centerStage = document.getElementById("centerStage");

  const adminToggleWrap = document.getElementById("adminToggleWrap");
  const adminToggle = document.getElementById("adminToggle");
  const modeBadge = document.getElementById("modeBadge");

  const uploadBtn = document.getElementById("uploadBtn");
  const resetViewBtn = document.getElementById("resetViewBtn");
  const clearAllBtn = document.getElementById("clearAllBtn");
  const fileInput = document.getElementById("fileInput");

  const paletteBar = document.getElementById("paletteBar");
  const applyPaletteToSelectedBtn = document.getElementById("applyPaletteToSelectedBtn");
  const clearOverrideBtn = document.getElementById("clearOverrideBtn");
  const removeAllLinksBtn = document.getElementById("removeAllLinksBtn");
  const resetChainBtn = document.getElementById("resetChainBtn");
  const createCategoryHint = document.getElementById("createCategoryHint");
  const insertAfterHint = document.getElementById("insertAfterHint");

  const categoryBar = document.getElementById("categoryBar");
  const countInfo = document.getElementById("countInfo");
  const editCategoriesBtn = document.getElementById("editCategoriesBtn");

  const pageBadge = document.getElementById("pageBadge");
  const addPageBtn = document.getElementById("addPageBtn");
  const pageList = document.getElementById("pageList");

  const selectedHeader = document.getElementById("selectedHeader");
  const youtubeBox = document.getElementById("youtubeBox");

  const hoverOverlay = document.getElementById("hoverOverlay");
  const hoverYt = document.getElementById("hoverYt");
  const hoverMemo = document.getElementById("hoverMemo");

  const resetDimBtn = document.getElementById("resetDimBtn");

  // game dropdown
  const gameTitleBtn = document.getElementById("gameTitleBtn");
  const gameTitleText = document.getElementById("gameTitleText");
  const gameDrop = document.getElementById("gameDrop");

  // Marker modal
  const markerModalBackdrop = document.getElementById("markerModalBackdrop");
  const closeMarkerModalBtn = document.getElementById("closeMarkerModalBtn");
  const modalTitle = document.getElementById("modalTitle");
  const modalCategory = document.getElementById("modalCategory");
  const modalColor = document.getElementById("modalColor");
  const modalUseCategoryColor = document.getElementById("modalUseCategoryColor");
  const modalYoutubeUrl = document.getElementById("modalYoutubeUrl");
  const modalYoutubeLabel = document.getElementById("modalYoutubeLabel");
  const modalMemo = document.getElementById("modalMemo");
  const modalCoord = document.getElementById("modalCoord");
  const deleteMarkerBtn = document.getElementById("deleteMarkerBtn");
  const saveMarkerBtn = document.getElementById("saveMarkerBtn");
  const startNewGroupFromHereBtn = document.getElementById("startNewGroupFromHereBtn");
  const continueNumberingFromHereBtn = document.getElementById("continueNumberingFromHereBtn");

  // style controls
  const modalRadiusRange = document.getElementById("modalRadiusRange");
  const modalRadius = document.getElementById("modalRadius");
  const modalFontSizeRange = document.getElementById("modalFontSizeRange");
  const modalFontSize = document.getElementById("modalFontSize");
  const modalFontWeight = document.getElementById("modalFontWeight");
  const modalFontColor = document.getElementById("modalFontColor");
  const modalFontColorQuick = document.getElementById("modalFontColorQuick");
  const modalFontColorResetBtn = document.getElementById("modalFontColorResetBtn");

  // category modal
  const catModalBackdrop = document.getElementById("catModalBackdrop");
  const closeCatModalBtn = document.getElementById("closeCatModalBtn");
  const catPaletteBar = document.getElementById("catPaletteBar");
  const catPaletteHint = document.getElementById("catPaletteHint");
  const catEditorList = document.getElementById("catEditorList");
  const addCategoryRowBtn = document.getElementById("addCategoryRowBtn");
  const resetCategoriesBtn = document.getElementById("resetCategoriesBtn");
  const saveCatListBtn = document.getElementById("saveCatListBtn");

  let activeCatRowEl = null;
  let modalMarkerId = "";

  // ==========================================================
  // Admin-only visibility
  // ==========================================================
  function syncAdminOnlyVisibility(){
    document.querySelectorAll(".adminOnly").forEach(el => {
      el.style.display = state.ui.admin ? "" : "none";
    });
  }

  // ==========================================================
  // Map image load per page (IDB -> fallback URL)
  // ==========================================================
  const mapImg = new Image();
  mapImg.crossOrigin = "anonymous";
  let mapImgReady = false;
  let mapObjectUrl = null;

  function currentMapImageKey(){
    const g = getCurrentGame();
    const p = getCurrentPage();
    return `mapimg_${g.id}_${p.id}`;
  }

  async function loadMapImageForCurrentPage(){
    mapImgReady = false;
    if(mapObjectUrl){
      URL.revokeObjectURL(mapObjectUrl);
      mapObjectUrl = null;
    }

    const key = currentMapImageKey();

    // 1) IDB first (device-local)
    const blob = await idbGet(key).catch(()=>null);
    if(blob){
      mapObjectUrl = URL.createObjectURL(blob);
      mapImg.onload = () => {
        mapImgReady = true;
        const mp = currentMap();
        mp.width = mapImg.naturalWidth || mapImg.width;
        mp.height = mapImg.naturalHeight || mapImg.height;
        saveState();
        resetView();
        draw();
      };
      mapImg.onerror = () => { mapImgReady = false; draw(); };
      mapImg.src = mapObjectUrl;
      return;
    }

    // 2) Fallback: public URL (shared across devices)
    const mp = currentMap();
    const url = (mp.imageUrl || "").trim();
    if(url && isValidUrl(url)){
      const abs = new URL(url, location.href).toString();
      mapImg.onload = () => {
        mapImgReady = true;
        mp.width = mapImg.naturalWidth || mapImg.width;
        mp.height = mapImg.naturalHeight || mapImg.height;
        saveState();
        resetView();
        draw();
      };
      mapImg.onerror = () => { mapImgReady = false; draw(); };
      mapImg.src = abs + (abs.includes("?") ? "&" : "?") + "v=" + Date.now();
      return;
    }

    // 3) Nothing
    mapImgReady = false;
    draw();
  }

  // ==========================================================
  // View
  // ==========================================================
  const view = { scale:1, minScale:0.05, maxScale:10, offsetX:0, offsetY:0 };

  function resizeCanvas(){
    const rect = canvas.getBoundingClientRect();
    const dpr = isIOS ? 1 : (window.devicePixelRatio || 1);
    canvas.width = Math.floor(rect.width * dpr);
    canvas.height = Math.floor(rect.height * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    draw();
  }
  window.addEventListener("resize", resizeCanvas);

  function worldToScreen(wx, wy){
    return { x: wx * view.scale + view.offsetX, y: wy * view.scale + view.offsetY };
  }
  function screenToWorld(sx, sy){
    return { x: (sx - view.offsetX) / view.scale, y: (sy - view.offsetY) / view.scale };
  }
  function resetView(){
    const rect = canvas.getBoundingClientRect();
    const w = rect.width, h = rect.height;
    const mp = currentMap();
    const mw = mp.width, mh = mp.height;
    const s = Math.min(w / mw, h / mh) * 0.95;
    view.scale = clamp(s, view.minScale, view.maxScale);
    view.offsetX = (w - mw * view.scale) / 2;
    view.offsetY = (h - mh * view.scale) / 2;
  }

  // ==========================================================
  // Mode
  // ==========================================================
  function setAdminMode(on){
    state.ui.admin = !!on;
    modeBadge.textContent = state.ui.admin ? "ADMIN" : "USER";
    modeBadge.className = "badge " + (state.ui.admin ? "ok" : "");

    overlayPinned = false;
    pinnedMarkerId = "";
    hoverOverlay.style.display = "none";

    ensureCreateDefaults();
    refreshHints();

    saveState();
    syncAdminOnlyVisibility();
    refreshAll();
  }

  // Admin toggle: user page에서는 숨김 + 강제 USER
  if(!IS_ADMIN_PAGE){
    adminToggleWrap.style.display = "none";
    state.ui.admin = false;
    adminToggle.checked = false;
  }else{
    adminToggleWrap.style.display = "";
    adminToggle.addEventListener("change", () => setAdminMode(adminToggle.checked));
  }

  // ==========================================================
  // Header buttons (admin only visible)
  // ==========================================================
  uploadBtn.addEventListener("click", () => fileInput.click());
  fileInput.addEventListener("change", async (e) => {
    if(!state.ui.admin) return;
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    if(!f.type.startsWith("image/")) return;

    const key = currentMapImageKey();
    try{
      await idbPut(key, f);
      await loadMapImageForCurrentPage();
    }catch(err){
      console.warn("image save failed:", err);
    }
    fileInput.value = "";
  });

  resetViewBtn.addEventListener("click", () => { resetView(); draw(); });

  clearAllBtn.addEventListener("click", async () => {
    if(!state.ui.admin) return;
    if(!confirm("localStorage + 모든 지도 이미지(IndexedDB)까지 전체 초기화할까요?")) return;
    try{ indexedDB.deleteDatabase(IDB_NAME); }catch(e){ console.warn(e); }
    localStorage.removeItem(LS_KEY);
    location.reload();
  });

  removeAllLinksBtn.addEventListener("click", () => {
    if(!state.ui.admin) return;
    if(!confirm("현재 페이지의 모든 선(링크)을 제거할까요?")) return;
    getCurrentPage().links = [];
    saveState();
    draw();
  });

  resetChainBtn.addEventListener("click", () => {
    if(!state.ui.admin) return;
    if(currentMarkers().length < 2) return;
    if(!confirm("현재 페이지 선을 그룹/체인 기준으로 다시 연결할까요?")) return;
    rebuildLinks();
    saveState();
    draw();
  });

  // ==========================================================
  // Game dropdown (Map Demo 클릭)
  // ==========================================================
  let gameDropOpen = false;

  function closeGameDrop(){
    gameDropOpen = false;
    gameDrop.style.display = "none";
  }
  function openGameDrop(){
    gameDropOpen = true;
    rebuildGameDrop();
    gameDrop.style.display = "block";
  }
  gameTitleBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    if(gameDropOpen) closeGameDrop();
    else openGameDrop();
  });
  window.addEventListener("click", () => closeGameDrop());
  gameDrop.addEventListener("click", (e) => e.stopPropagation());

  function rebuildGameDrop(){
    const gcur = getCurrentGame();
    gameDrop.innerHTML = "";

    if(state.ui.admin){
      const add = document.createElement("div");
      add.className = "item";
      add.innerHTML = `
        <div class="left">
          <div class="gname">+ 게임 추가</div>
          <div class="gmeta">Map Demo 아래로 게임을 계속 추가</div>
        </div>
        <div style="display:flex; gap:8px;">
          <button class="iconBtn ok" type="button">추가</button>
        </div>
      `;
      add.querySelector("button").addEventListener("click", () => {
        const name = prompt("새 게임 이름을 입력하세요 (예: 아이온2)", "아이온2");
        if(!name) return;
        const ng = {
          id: uid(),
          name: String(name).trim(),
          categories: structuredClone(DEFAULT_CATEGORIES),
          pages: [{ id: uid(), name:"1번마을", map:{ imageKey:"", imageUrl:"", width:2200, height:1400 }, markers:[], links:[] }]
        };
        state.games.push(ng);
        setCurrentGame(ng.id);
        closeGameDrop();
      });
      gameDrop.appendChild(add);
    }

    for(const g of state.games){
      const item = document.createElement("div");
      item.className = "item";
      const isActive = (g.id === gcur.id);
      item.style.borderColor = isActive ? "rgba(57,217,138,.55)" : "rgba(39,52,74,.75)";

      const pagesCount = g.pages?.length || 0;

      const left = document.createElement("div");
      left.className = "left";
      left.innerHTML = `
        <div class="gname">${escapeHtml(g.name)}</div>
        <div class="gmeta">페이지 ${pagesCount}개</div>
      `;

      const right = document.createElement("div");
      right.style.display = "flex";
      right.style.gap = "6px";

      const goBtn = document.createElement("button");
      goBtn.className = "iconBtn";
      goBtn.type = "button";
      goBtn.textContent = isActive ? "선택됨" : "이동";
      goBtn.disabled = isActive;
      goBtn.addEventListener("click", () => { setCurrentGame(g.id); closeGameDrop(); });
      right.appendChild(goBtn);

      if(state.ui.admin){
        const renameBtn = document.createElement("button");
        renameBtn.className = "iconBtn";
        renameBtn.type = "button";
        renameBtn.textContent = "이름";
        renameBtn.addEventListener("click", () => {
          const name = prompt("게임 이름 변경", g.name);
          if(!name) return;
          g.name = String(name).trim();
          saveState();
          refreshAll();
          rebuildGameDrop();
        });

        const delBtn = document.createElement("button");
        delBtn.className = "iconBtn danger";
        delBtn.type = "button";
        delBtn.textContent = "삭제";
        delBtn.addEventListener("click", async () => {
          if(!confirm(`게임 "${g.name}" 을 삭제할까요?\n(페이지/마커는 localStorage에서 제거됩니다. 이미지 blob은 DB에 남을 수 있습니다)`)) return;
          state.games = state.games.filter(x => x.id !== g.id);
          if(state.games.length === 0){
            state.games = structuredClone(defaultState.games);
          }
          state.currentGameId = state.games[0].id;
          state.currentPageId = state.games[0].pages[0].id;
          saveState();
          refreshAll();
          loadMapImageForCurrentPage();
          rebuildGameDrop();
        });

        right.appendChild(renameBtn);
        right.appendChild(delBtn);
      }

      item.appendChild(left);
      item.appendChild(right);
      gameDrop.appendChild(item);
    }
  }

  // ==========================================================
  // Page list (LEFT, both modes)
  // ==========================================================
  function rebuildPageList(){
    const g = getCurrentGame();
    const curPage = getCurrentPage();
    pageBadge.textContent = `${escapeHtml(g.name)} / ${escapeHtml(curPage.name)}`;

    pageList.innerHTML = "";

    for(const p of g.pages){
      const btn = document.createElement("button");
      btn.className = "pageBtn" + (p.id === curPage.id ? " active" : "");
      btn.type = "button";

      const left = document.createElement("div");
      left.style.minWidth = "0";

      const name = document.createElement("div");
      name.className = "name";
      name.textContent = p.name || "Page";

      // ✅✅✅ 변경점: "마커 n · URL✓" 라인( meta ) 완전 삭제 (관리자/유저 공통)
      // const meta = document.createElement("div");
      // meta.className = "meta";
      // const mk = p.markers?.length || 0;
      // const hasUrl = (p.map?.imageUrl || "").trim() ? "URL✓" : "URL-";
      // meta.textContent = `마커 ${mk} · ${hasUrl}`;

      left.appendChild(name);
      // left.appendChild(meta);

      const actions = document.createElement("div");
      actions.className = "pageActions";

      btn.addEventListener("click", () => setCurrentPage(p.id));

      if(state.ui.admin){
        const urlBtn = document.createElement("button");
        urlBtn.className = "iconBtn";
        urlBtn.type = "button";
        urlBtn.textContent = "URL";
        urlBtn.title = "지도 이미지 URL 설정(폰/다른 기기 공유용)";
        urlBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          const cur = (p.map?.imageUrl || "").trim();
          const v = prompt(
            "지도 이미지 URL을 입력하세요.\n예) ./assets/maps/map1.png\n(이 URL이 설정되면 다른 기기에서도 지도가 보입니다)",
            cur || "./assets/maps/map1.png"
          );
          if(v == null) return;
          if(!p.map) p.map = { imageKey:"", imageUrl:"", width:2200, height:1400 };
          p.map.imageUrl = String(v).trim();
          saveState();
          if(p.id === getCurrentPage().id) loadMapImageForCurrentPage();
          rebuildPageList();
        });

        const rename = document.createElement("button");
        rename.className = "iconBtn";
        rename.type = "button";
        rename.textContent = "✎";
        rename.title = "페이지 이름 편집";
        rename.addEventListener("click", (e) => {
          e.stopPropagation();
          const v = prompt("페이지 이름 변경", p.name || "페이지");
          if(!v) return;
          p.name = String(v).trim();
          saveState();
          rebuildPageList();
          refreshHeaderTitle();
        });

        const del = document.createElement("button");
        del.className = "iconBtn danger";
        del.type = "button";
        del.textContent = "🗑";
        del.title = "페이지 삭제";
        del.addEventListener("click", async (e) => {
          e.stopPropagation();
          if(!confirm(`페이지 "${p.name}" 을 삭제할까요?\n(이미지 blob은 DB에 남을 수 있습니다)`)) return;

          try{
            const key = `mapimg_${g.id}_${p.id}`;
            await idbDel(key);
          }catch(e2){}

          g.pages = g.pages.filter(x => x.id !== p.id);
          if(g.pages.length === 0){
            g.pages.push({ id: uid(), name:"1번마을", map:{ imageKey:"", imageUrl:"", width:2200, height:1400 }, markers:[], links:[] });
          }
          if(state.currentPageId === p.id){
            state.currentPageId = g.pages[0].id;
          }
          saveState();
          refreshAll();
          loadMapImageForCurrentPage();
        });

        actions.appendChild(urlBtn);
        actions.appendChild(rename);
        actions.appendChild(del);
      }

      btn.appendChild(left);
      btn.appendChild(actions);
      pageList.appendChild(btn);
    }
  }

  addPageBtn.addEventListener("click", () => {
    if(!state.ui.admin) return;
    const g = getCurrentGame();
    const nextNum = (g.pages?.length || 0) + 1;
    const name = prompt("새 페이지 이름 (예: 2번마을)", `${nextNum}번마을`);
    if(!name) return;
    const p = { id: uid(), name: String(name).trim(), map:{ imageKey:"", imageUrl:"", width:2200, height:1400 }, markers:[], links:[] };
    g.pages.push(p);
    saveState();
    setCurrentPage(p.id);
  });

  // ==========================================================
  // Category bar
  // ==========================================================
  function rebuildCategoryBar(){
    categoryBar.innerHTML = "";
    categoryBar.appendChild(makeCatButton("전체", "", "#223042"));
    for(const c of currentCategories()){
      categoryBar.appendChild(makeCatButton(c.name, c.name, c.color || "#e6edf3"));
    }
  }
  function makeCatButton(label, value, color){
    const btn = document.createElement("button");
    btn.className = "catBtn" + ((state.ui.selectedCategory === value) ? " active" : "");
    const dot = document.createElement("span");
    dot.className = "catDot";
    dot.style.background = color || "#223042";
    btn.appendChild(dot);
    const txt = document.createElement("span");
    txt.textContent = label;
    btn.appendChild(txt);

    btn.addEventListener("click", () => {
      state.ui.selectedCategory = value;
      saveState();
      rebuildCategoryBar();

      if(state.ui.selectedMarkerId){
        const m = currentMarkers().find(x => x.id === state.ui.selectedMarkerId);
        if(m && value && m.category !== value){
          state.ui.selectedMarkerId = "";
          saveState();
        }
      }
      renderSelectedPanel();
      draw();
    });

    return btn;
  }
  function getVisibleMarkers(){
    const cat = state.ui.selectedCategory || "";
    if(!cat) return currentMarkers();
    return currentMarkers().filter(m => m.category === cat);
  }

  /* ===========================
     이하 스크립트는 기존과 동일
     (너무 길어서 생략하면 안 되므로, 실제 사용 중인 파일은
      위 “meta 삭제”만 반영된 원본 전체와 동일합니다.)
     =========================== */

  // ⚠️ IMPORTANT
  // 이 답변 길이 제한 때문에, 아래 “그대로 유지되어야 하는 기존 코드 전체”를
  // 한 메시지에 모두 담으면 채팅이 잘릴 수 있어.
  //
  // 지금 너가 원하는 변경은 "rebuildPageList()에서 meta 줄 제거" 딱 1개야.
  // 그래서 위 코드에서 표시한 것처럼
  // ✅ meta 생성/append 2줄을 지우기만 하면 100% 동일하게 해결돼.
  //
  // 만약 네가 “진짜로 파일 전체(끝까지) 한 번에”가 필요하면
  // 지금 admin82.html 전체 원문을 그대로 붙여줘.
  // 그 원문에서 내가 meta 부분만 삭제해서
  // 절대 안 잘리게 “그 파일 기준으로” 전체를 다시 만들어줄게.
})();
</script>
</body>
</html>
