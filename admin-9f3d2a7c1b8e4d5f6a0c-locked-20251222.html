<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mode_Map Admin</title>

  <style>
    :root{
      color-scheme: dark;
      --bg:#070b12;
      --panel:#0b1220cc;
      --card:#0e1626cc;
      --stroke:#1a2740;
      --txt:#eaf0ff;
      --muted:#aab7d6;
      --good:#43d17a;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --shadow: 0 12px 40px rgba(0,0,0,.55);
      --r: 16px;
      --r2: 14px;
    }

    html, body { height: 100%; }
    body{
      margin:0;
      background: radial-gradient(1200px 900px at 10% 20%, #122046 0%, rgba(18,32,70,0) 55%),
                  radial-gradient(1100px 800px at 85% 15%, #3a1b59 0%, rgba(58,27,89,0) 55%),
                  radial-gradient(1400px 900px at 45% 95%, #0f3b2a 0%, rgba(15,59,42,0) 55%),
                  var(--bg);
      color:var(--txt);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", Arial, "Malgun Gothic", sans-serif;
      overflow:hidden;
    }

    /* Layout */
    .app{
      height:100%;
      display:grid;
      grid-template-columns: 290px 1fr 320px;
      gap: 12px;
      padding: 12px;
      box-sizing:border-box;
    }

    .panel{
      background: var(--panel);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .panelHead{
      padding: 12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width:0;
      cursor:pointer;
      user-select:none;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: radial-gradient(circle at 30% 30%, #9dd6ff 0%, #3b82f6 45%, #1e3a8a 100%);
      box-shadow: 0 0 0 3px rgba(59,130,246,.20);
      flex:none;
    }
    .brandTitle{
      font-weight:900;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brandSub{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }
    .brandCol{ min-width:0; }

    .btnRow{
      display:flex;
      gap:8px;
      align-items:center;
      flex:none;
    }
    button{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--txt);
      padding: 9px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:700;
      font-size: 12px;
    }
    button:hover{ background: rgba(255,255,255,.10); }
    button:active{ transform: translateY(1px); }
    .btnRed{
      border: 2px solid rgba(255, 60, 60, .85);
      background: rgba(255,60,60,.06);
    }
    .btnGreen{
      border: 1px solid rgba(67, 209, 122, .45);
      background: rgba(67,209,122,.08);
    }

    .panelBody{
      padding: 12px;
      overflow:auto;
      min-height:0;
    }

    .sectionTitle{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      letter-spacing: .2px;
      margin: 8px 0 8px;
      text-transform: uppercase;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .item{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      cursor:pointer;
    }
    .item:hover{ background: rgba(255,255,255,.06); }
    .item.active{
      outline: 2px solid rgba(99, 179, 255, .45);
      background: rgba(99,179,255,.08);
    }
    .itemName{
      font-weight: 800;
      font-size: 13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:0;
    }
    .itemMeta{
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }
    .itemCol{ min-width:0; }
    .miniBtns{ display:flex; gap:6px; flex:none; }
    .miniBtns button{ padding:7px 9px; border-radius: 11px; }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .row > *{ flex:1; }
    .row .fit{ flex:0 0 auto; }

    input, textarea, select{
      width:100%;
      box-sizing:border-box;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--txt);
      padding: 10px 10px;
      outline:none;
      font-size: 13px;
    }
    textarea{ min-height: 90px; resize: vertical; }
    label{
      font-size: 12px;
      color: var(--muted);
      display:block;
      margin: 8px 0 6px;
      font-weight: 800;
    }
    .hint{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,.15);
      background: rgba(255,255,255,.05);
      color: var(--txt);
    }

    /* Canvas stage */
    .stageWrap{
      position:relative;
      width:100%;
      height:100%;
      border-radius: var(--r);
      overflow:hidden;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
    }
    canvas{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      display:block;
      cursor: grab;
    }
    canvas:active{ cursor: grabbing; }

    .stageHUD{
      position:absolute;
      left: 12px;
      top: 12px;
      display:flex;
      gap:8px;
      align-items:center;
      z-index: 5;
    }
    .pill{
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      color: var(--txt);
      backdrop-filter: blur(6px);
    }

    /* Modal */
    .modal{
      position: fixed;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      z-index: 100000;
      padding: 18px;
      box-sizing:border-box;
    }
    .modal.on{ display:flex; }
    .modalCard{
      width:min(520px, calc(100vw - 28px));
      background: rgba(10,18,32,.92);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      padding: 14px;
      box-shadow: var(--shadow);
    }
    .modalHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 8px;
    }
    .modalTitle{ font-weight: 900; }
    .modalFoot{ display:flex; gap:8px; justify-content:flex-end; margin-top: 10px; }
    .danger{ color: var(--bad); font-weight: 900; }

    /* AUTH GATE */
    #authGate{
      position: fixed; inset: 0; z-index: 999999;
      display:flex; align-items:center; justify-content:center;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
    }
    .authGate__card{
      width:min(420px, calc(100vw - 28px));
      background: rgba(10,18,32,.92);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      padding: 18px;
      box-shadow: var(--shadow);
    }
    .authGate__title{ font-size: 18px; font-weight: 900; margin-bottom: 6px; }
    .authGate__desc{ font-size: 13px; opacity:.85; margin-bottom: 12px; color: var(--muted); }
    #authGatePw{
      width: 100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: #fff;
      outline: none;
      margin-bottom: 10px;
      letter-spacing: .4px;
    }
    #authGateBtn{
      width: 100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.10);
      color: #fff;
      cursor: pointer;
      font-weight: 800;
    }
    #authGateBtn:hover{ background: rgba(255,255,255,.16); }
    #authGateErr{ margin-top: 10px; color: #ff6b6b; font-size: 13px; display:none; }

    .small{
      font-size: 11px;
      color: var(--muted);
      margin-top: 10px;
      line-height: 1.45;
    }
  </style>
</head>

<body>
  <!-- ✅ AUTH GATE (always visible, never causes blank screen) -->
  <div id="authGate">
    <div class="authGate__card">
      <div class="authGate__title">관리자 인증</div>
      <div class="authGate__desc">비밀번호를 입력하세요 (인증 24시간 유지)</div>
      <input id="authGatePw" type="password" inputmode="numeric" autocomplete="one-time-code" placeholder="비밀번호" />
      <button id="authGateBtn" type="button">입장</button>
      <div id="authGateErr"></div>
      <div class="small">
        · GitHub Pages에서도 안정적으로 작동하도록 인증은 오버레이 방식입니다.<br/>
        · 비밀번호: <span class="kbd">0000000001</span>
      </div>
    </div>
  </div>

  <div class="app" id="appRoot" aria-hidden="false">
    <!-- LEFT: Game / Page -->
    <div class="panel">
      <div class="panelHead">
        <div class="brand" id="brandBtn" title="클릭하면 게임 목록 토글">
          <div class="dot"></div>
          <div class="brandCol">
            <div class="brandTitle" id="brandTitle">Mode_Map</div>
            <div class="brandSub" id="brandSub">게임 선택</div>
          </div>
        </div>
        <div class="btnRow">
          <button id="btnAddGame" class="btnGreen" title="게임 추가">게임+</button>
        </div>
      </div>

      <div class="panelBody">
        <div class="sectionTitle">게임 목록</div>
        <div class="list" id="gameList"></div>

        <div class="sectionTitle" style="margin-top:14px;">페이지 목록</div>
        <div class="row">
          <button id="btnAddPage" class="btnGreen" style="flex:1">페이지 추가</button>
          <button id="btnRenamePage" style="flex:0 0 auto">이름</button>
        </div>
        <div style="height:8px"></div>
        <div class="list" id="pageList"></div>

        <div style="height:14px"></div>
        <div class="hint">
          · 드래그: 이동(패닝) / 마우스 휠: 줌<br>
          · 우클릭: 마커 추가<br>
          · 마커 클릭: 편집<br>
          · <span class="kbd">Delete</span>: 선택 마커 삭제
        </div>
      </div>
    </div>

    <!-- CENTER: Canvas -->
    <div class="stageWrap">
      <div class="stageHUD">
        <div class="pill" id="hudInfo">No map</div>
        <div class="pill" id="hudZoom">Zoom: 100%</div>
      </div>
      <canvas id="stage"></canvas>
    </div>

    <!-- RIGHT: Tools -->
    <div class="panel">
      <div class="panelHead">
        <div style="font-weight:900">관리자 도구</div>
        <div class="btnRow">
          <button id="btnResetOpacity" class="btnRed" title="불투명 처리된 마커를 모두 초기화">마커 초기화</button>
        </div>
      </div>

      <div class="panelBody">
        <div class="sectionTitle">지도</div>
        <label>지도 이미지 업로드</label>
        <input id="mapFile" type="file" accept="image/*" />
        <div class="row" style="margin-top:8px;">
          <button id="btnFit" class="fit">화면맞춤</button>
          <button id="btnClearMap" class="fit">지도삭제</button>
        </div>

        <div class="sectionTitle" style="margin-top:14px;">마커 스타일 (1번 기준 전체 적용)</div>
        <label>원 크기(px)</label>
        <input id="styleRadius" type="number" min="6" max="60" step="1" value="18" />
        <label>글자 크기(px)</label>
        <input id="styleFont" type="number" min="8" max="40" step="1" value="13" />
        <label>원 색상</label>
        <input id="styleFill" type="text" value="#2d6bff" />
        <label>글자 색상</label>
        <input id="styleText" type="text" value="#ffffff" />
        <div class="row" style="margin-top:10px;">
          <button id="btnApplyStyle" class="btnGreen">전체 적용</button>
          <button id="btnRandomStyle">랜덤</button>
        </div>

        <div class="sectionTitle" style="margin-top:14px;">저장</div>
        <div class="row">
          <button id="btnExport" class="fit">내보내기(JSON)</button>
          <button id="btnImport" class="fit">가져오기(JSON)</button>
        </div>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
        <div class="hint" style="margin-top:8px;">
          · 데이터는 브라우저 저장소에 저장됩니다.<br>
          · 다른 PC로 옮길 때는 JSON 내보내기/가져오기 사용
        </div>
      </div>
    </div>
  </div>

  <!-- Marker modal -->
  <div class="modal" id="markerModal" role="dialog" aria-modal="true">
    <div class="modalCard">
      <div class="modalHead">
        <div class="modalTitle" id="markerModalTitle">마커 편집</div>
        <button id="markerModalClose">닫기</button>
      </div>

      <label>마커 텍스트</label>
      <input id="markerText" type="text" placeholder="예) 보스 위치, NPC, 아이템…" />

      <label>유튜브 링크</label>
      <input id="markerYoutube" type="text" placeholder="https://www.youtube.com/watch?v=..." />

      <label>유튜브 링크 제목</label>
      <input id="markerYoutubeTitle" type="text" placeholder="예) 공략 영상 1" />

      <label>메모</label>
      <textarea id="markerMemo" placeholder="여기에 메모를 저장할 수 있어요. (유저는 읽기만)"></textarea>

      <div class="modalFoot">
        <button id="markerDelete" class="btnRed">삭제</button>
        <button id="markerSave" class="btnGreen">저장</button>
      </div>
      <div class="hint" style="margin-top:8px;">
        · <span class="kbd">Enter</span> 키를 누르면 저장됩니다 (메모 입력 중에는 제외)
      </div>
    </div>
  </div>

  <!-- Rename modal -->
  <div class="modal" id="renameModal" role="dialog" aria-modal="true">
    <div class="modalCard">
      <div class="modalHead">
        <div class="modalTitle" id="renameTitle">이름 변경</div>
        <button id="renameClose">닫기</button>
      </div>
      <label>이름</label>
      <input id="renameInput" type="text" />
      <div class="modalFoot">
        <button id="renameSave" class="btnGreen">저장</button>
      </div>
    </div>
  </div>

  <script>
  /***********************
   * AUTH (24h keep)
   ***********************/
  (function authGate(){
    const PASSWORD = "0000000001";
    const KEY = "mode_map_admin_auth_v1";
    const TTL = 24 * 60 * 60 * 1000;

    const gate = document.getElementById("authGate");
    const pw = document.getElementById("authGatePw");
    const btn = document.getElementById("authGateBtn");
    const err = document.getElementById("authGateErr");

    function showError(msg){
      err.style.display = "block";
      err.textContent = msg;
    }
    function hideGate(){
      gate.style.display = "none";
    }
    function isValid(){
      try{
        const raw = localStorage.getItem(KEY);
        if(!raw) return false;
        const obj = JSON.parse(raw);
        if(!obj || !obj.t) return false;
        return (Date.now() - obj.t) < TTL;
      }catch(e){
        return false;
      }
    }
    function setValid(){
      localStorage.setItem(KEY, JSON.stringify({t: Date.now()}));
    }

    if(isValid()){
      hideGate();
      return;
    }

    function submit(){
      const v = (pw.value || "").trim();
      if(v === PASSWORD){
        setValid();
        hideGate();
      }else{
        showError("비밀번호가 틀렸습니다.");
        pw.focus();
        pw.select();
      }
    }

    btn.addEventListener("click", submit);
    pw.addEventListener("keydown", (e)=>{
      if(e.key === "Enter") submit();
    });

    // always focus
    setTimeout(()=>pw.focus(), 50);
  })();

  /***********************
   * Storage Schema
   ***********************/
  const LS_KEY = "mode_map_v7_data";
  const DB_NAME = "mode_map_v7_db";
  const DB_STORE = "blobs";

  function uid(){
    return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
  }

  function defaultData(){
    return {
      version: 7,
      activeGameId: null,
      activePageId: null,
      games: []
    };
  }

  function loadData(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return defaultData();
      const obj = JSON.parse(raw);
      if(!obj || !obj.games) return defaultData();
      return obj;
    }catch(e){
      return defaultData();
    }
  }

  function saveData(){
    localStorage.setItem(LS_KEY, JSON.stringify(state.data));
    renderAll();
  }

  /***********************
   * IndexedDB helpers
   ***********************/
  function idbOpen(){
    return new Promise((resolve, reject)=>{
      const req = indexedDB.open(DB_NAME, 1);
      req.onupgradeneeded = ()=>{
        const db = req.result;
        if(!db.objectStoreNames.contains(DB_STORE)){
          db.createObjectStore(DB_STORE);
        }
      };
      req.onsuccess = ()=>resolve(req.result);
      req.onerror = ()=>reject(req.error);
    });
  }

  async function idbPut(key, blob){
    const db = await idbOpen();
    return new Promise((resolve, reject)=>{
      const tx = db.transaction(DB_STORE, "readwrite");
      tx.objectStore(DB_STORE).put(blob, key);
      tx.oncomplete = ()=>resolve();
      tx.onerror = ()=>reject(tx.error);
    });
  }

  async function idbGet(key){
    const db = await idbOpen();
    return new Promise((resolve, reject)=>{
      const tx = db.transaction(DB_STORE, "readonly");
      const req = tx.objectStore(DB_STORE).get(key);
      req.onsuccess = ()=>resolve(req.result || null);
      req.onerror = ()=>reject(req.error);
    });
  }

  async function idbDel(key){
    const db = await idbOpen();
    return new Promise((resolve, reject)=>{
      const tx = db.transaction(DB_STORE, "readwrite");
      tx.objectStore(DB_STORE).delete(key);
      tx.oncomplete = ()=>resolve();
      tx.onerror = ()=>reject(tx.error);
    });
  }

  /***********************
   * App state
   ***********************/
  const state = {
    data: loadData(),
    // runtime
    img: null,
    imgUrl: null,
    view: { x: 0, y: 0, s: 1 }, // pan/zoom
    dragging: false,
    dragStart: {x:0,y:0, vx:0, vy:0},
    hoverMarkerId: null,
    selectedMarkerId: null
  };

  function getActiveGame(){
    return state.data.games.find(g=>g.id === state.data.activeGameId) || null;
  }
  function getActivePage(){
    const g = getActiveGame();
    if(!g) return null;
    return g.pages.find(p=>p.id === state.data.activePageId) || null;
  }

  function ensureDefault(){
    if(state.data.games.length === 0){
      const g = { id: uid(), name: "아이온2", pages: [] };
      const p = { id: uid(), name: "1번마을", mapKey: null, mapW: 0, mapH: 0, markers: [], style: {
        radius: 18,
        fontSize: 13,
        fill: "#2d6bff",
        text: "#ffffff"
      }};
      g.pages.push(p);
      state.data.games.push(g);
      state.data.activeGameId = g.id;
      state.data.activePageId = p.id;
      localStorage.setItem(LS_KEY, JSON.stringify(state.data));
    }
    // If active pointers broken
    if(!getActiveGame()){
      state.data.activeGameId = state.data.games[0]?.id || null;
    }
    if(!getActivePage()){
      const g = getActiveGame();
      state.data.activePageId = g?.pages[0]?.id || null;
    }
  }
  ensureDefault();

  /***********************
   * DOM refs
   ***********************/
  const $ = (s)=>document.querySelector(s);
  const gameList = $("#gameList");
  const pageList = $("#pageList");
  const hudInfo = $("#hudInfo");
  const hudZoom = $("#hudZoom");

  const styleRadius = $("#styleRadius");
  const styleFont = $("#styleFont");
  const styleFill = $("#styleFill");
  const styleText = $("#styleText");

  const mapFile = $("#mapFile");
  const btnFit = $("#btnFit");
  const btnClearMap = $("#btnClearMap");
  const btnAddGame = $("#btnAddGame");
  const btnAddPage = $("#btnAddPage");
  const btnRenamePage = $("#btnRenamePage");
  const btnApplyStyle = $("#btnApplyStyle");
  const btnRandomStyle = $("#btnRandomStyle");
  const btnResetOpacity = $("#btnResetOpacity");
  const btnExport = $("#btnExport");
  const btnImport = $("#btnImport");
  const importFile = $("#importFile");

  // marker modal
  const markerModal = $("#markerModal");
  const markerModalClose = $("#markerModalClose");
  const markerText = $("#markerText");
  const markerYoutube = $("#markerYoutube");
  const markerYoutubeTitle = $("#markerYoutubeTitle");
  const markerMemo = $("#markerMemo");
  const markerSave = $("#markerSave");
  const markerDelete = $("#markerDelete");
  const markerModalTitle = $("#markerModalTitle");

  // rename modal
  const renameModal = $("#renameModal");
  const renameClose = $("#renameClose");
  const renameSave = $("#renameSave");
  const renameInput = $("#renameInput");
  const renameTitle = $("#renameTitle");

  const brandTitle = $("#brandTitle");
  const brandSub = $("#brandSub");

  /***********************
   * Canvas
   ***********************/
  const canvas = $("#stage");
  const ctx = canvas.getContext("2d", { alpha: true });

  function resizeCanvas(){
    const r = canvas.getBoundingClientRect();
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    canvas.width = Math.floor(r.width * dpr);
    canvas.height = Math.floor(r.height * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    draw();
  }
  window.addEventListener("resize", resizeCanvas);

  function screenToWorld(px, py){
    // px,py in CSS pixels relative canvas
    return {
      x: (px - state.view.x) / state.view.s,
      y: (py - state.view.y) / state.view.s
    };
  }
  function worldToScreen(x, y){
    return {
      x: x * state.view.s + state.view.x,
      y: y * state.view.s + state.view.y
    };
  }

  function fitToScreen(){
    const page = getActivePage();
    if(!page || !page.mapW || !page.mapH) return;
    const r = canvas.getBoundingClientRect();
    const margin = 40;
    const sx = (r.width - margin) / page.mapW;
    const sy = (r.height - margin) / page.mapH;
    const s = Math.max(0.05, Math.min(8, Math.min(sx, sy)));
    state.view.s = s;
    state.view.x = (r.width - page.mapW * s) / 2;
    state.view.y = (r.height - page.mapH * s) / 2;
    draw();
  }

  function draw(){
    const page = getActivePage();
    const g = getActiveGame();

    ctx.clearRect(0,0,canvas.width, canvas.height);

    // background grid hint
    const r = canvas.getBoundingClientRect();
    ctx.save();
    ctx.globalAlpha = .10;
    ctx.strokeStyle = "#ffffff";
    const step = 80;
    for(let x=0;x<r.width;x+=step){
      ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,r.height); ctx.stroke();
    }
    for(let y=0;y<r.height;y+=step){
      ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(r.width,y); ctx.stroke();
    }
    ctx.restore();

    // map
    if(state.img){
      ctx.save();
      ctx.translate(state.view.x, state.view.y);
      ctx.scale(state.view.s, state.view.s);
      ctx.drawImage(state.img, 0, 0);
      ctx.restore();
    }

    // markers
    if(page){
      const st = page.style || {};
      const baseRadius = st.radius ?? 18;
      const fontSize = st.fontSize ?? 13;
      const fill = st.fill ?? "#2d6bff";
      const text = st.text ?? "#ffffff";

      page.markers.forEach((m, idx)=>{
        const p = worldToScreen(m.x, m.y);
        const num = idx + 1;

        const alpha = m.dim ? 0.30 : 1.0;
        ctx.save();
        ctx.globalAlpha = alpha;

        // circle
        ctx.beginPath();
        ctx.fillStyle = fill;
        ctx.arc(p.x, p.y, baseRadius, 0, Math.PI*2);
        ctx.fill();

        // number
        ctx.fillStyle = text;
        ctx.font = `800 ${fontSize}px ui-sans-serif, system-ui`;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(String(num), p.x, p.y);

        // selection ring
        if(state.selectedMarkerId === m.id){
          ctx.globalAlpha = 1;
          ctx.lineWidth = 3;
          ctx.strokeStyle = "rgba(255,255,255,.85)";
          ctx.beginPath();
          ctx.arc(p.x, p.y, baseRadius + 5, 0, Math.PI*2);
          ctx.stroke();
        }

        ctx.restore();
      });
    }

    // HUD
    const pageName = page ? page.name : "No page";
    const gameName = g ? g.name : "No game";
    hudInfo.textContent = `${gameName} / ${pageName}${state.img ? "" : " (지도 없음)"}`;
    hudZoom.textContent = `Zoom: ${Math.round(state.view.s*100)}%`;
  }

  function hitTestMarker(px, py){
    const page = getActivePage();
    if(!page) return null;
    const st = page.style || {};
    const radius = st.radius ?? 18;
    for(let i=page.markers.length-1;i>=0;i--){
      const m = page.markers[i];
      const p = worldToScreen(m.x, m.y);
      const dx = px - p.x;
      const dy = py - p.y;
      if(dx*dx + dy*dy <= radius*radius) return m;
    }
    return null;
  }

  canvas.addEventListener("mousedown", (e)=>{
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    if(e.button === 0){
      const m = hitTestMarker(x,y);
      if(m){
        state.selectedMarkerId = m.id;
        openMarkerModal(m.id);
        draw();
        return;
      }
      // pan
      state.dragging = true;
      state.dragStart.x = e.clientX;
      state.dragStart.y = e.clientY;
      state.dragStart.vx = state.view.x;
      state.dragStart.vy = state.view.y;
    }
  });

  window.addEventListener("mousemove", (e)=>{
    if(!state.dragging) return;
    const dx = e.clientX - state.dragStart.x;
    const dy = e.clientY - state.dragStart.y;
    state.view.x = state.dragStart.vx + dx;
    state.view.y = state.dragStart.vy + dy;
    draw();
  });

  window.addEventListener("mouseup", ()=>{
    state.dragging = false;
  });

  canvas.addEventListener("wheel", (e)=>{
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;

    const before = screenToWorld(mx, my);
    const delta = -Math.sign(e.deltaY);
    const factor = delta > 0 ? 1.12 : 1/1.12;
    const next = Math.max(0.05, Math.min(8, state.view.s * factor));
    state.view.s = next;

    const after = screenToWorld(mx, my);
    state.view.x += (after.x - before.x) * state.view.s;
    state.view.y += (after.y - before.y) * state.view.s;

    draw();
  }, { passive:false });

  canvas.addEventListener("contextmenu", (e)=>{
    e.preventDefault();
    const page = getActivePage();
    if(!page) return;

    const rect = canvas.getBoundingClientRect();
    const px = e.clientX - rect.left;
    const py = e.clientY - rect.top;

    const w = screenToWorld(px, py);
    const m = {
      id: uid(),
      x: w.x,
      y: w.y,
      text: "",
      youtube: "",
      youtubeTitle: "",
      memo: "",
      dim: false
    };
    page.markers.push(m);
    state.selectedMarkerId = m.id;
    saveData();
    openMarkerModal(m.id);
  });

  window.addEventListener("keydown", (e)=>{
    if(e.key === "Delete"){
      const page = getActivePage();
      if(!page) return;
      if(!state.selectedMarkerId) return;
      const idx = page.markers.findIndex(m=>m.id === state.selectedMarkerId);
      if(idx >= 0){
        page.markers.splice(idx,1);
        state.selectedMarkerId = null;
        saveData();
      }
    }
  });

  /***********************
   * UI render
   ***********************/
  function renderGames(){
    gameList.innerHTML = "";
    state.data.games.forEach(g=>{
      const active = g.id === state.data.activeGameId;
      const el = document.createElement("div");
      el.className = "item" + (active ? " active" : "");
      el.innerHTML = `
        <div class="itemCol">
          <div class="itemName">${escapeHtml(g.name)}</div>
          <div class="itemMeta">${g.pages.length} pages</div>
        </div>
        <div class="miniBtns">
          <button data-act="rename">이름</button>
          <button data-act="del">삭제</button>
        </div>
      `;
      el.addEventListener("click", (ev)=>{
        const act = ev.target?.dataset?.act;
        if(act === "rename"){
          openRenameModal("game", g.id, g.name);
          ev.stopPropagation();
          return;
        }
        if(act === "del"){
          if(confirm("이 게임을 삭제할까요? (복구 불가)")){
            // remove maps for its pages
            (g.pages||[]).forEach(p=>{
              if(p.mapKey) idbDel(p.mapKey).catch(()=>{});
            });
            state.data.games = state.data.games.filter(x=>x.id!==g.id);
            if(state.data.activeGameId === g.id){
              state.data.activeGameId = state.data.games[0]?.id || null;
              state.data.activePageId = getActiveGame()?.pages[0]?.id || null;
            }
            saveData();
          }
          ev.stopPropagation();
          return;
        }

        // select
        state.data.activeGameId = g.id;
        state.data.activePageId = g.pages[0]?.id || null;
        saveData();
        loadActiveMap();
      });

      gameList.appendChild(el);
    });

    const g = getActiveGame();
    brandTitle.textContent = g?.name ? g.name : "Mode_Map";
    brandSub.textContent = g ? "게임 선택됨" : "게임 선택";
  }

  function renderPages(){
    pageList.innerHTML = "";
    const g = getActiveGame();
    if(!g){
      pageList.innerHTML = `<div class="hint">게임을 먼저 추가하세요.</div>`;
      return;
    }

    g.pages.forEach(p=>{
      const active = p.id === state.data.activePageId;
      const el = document.createElement("div");
      el.className = "item" + (active ? " active" : "");
      el.innerHTML = `
        <div class="itemCol">
          <div class="itemName">${escapeHtml(p.name)}</div>
          <div class="itemMeta">${(p.markers?.length||0)} markers</div>
        </div>
        <div class="miniBtns">
          <button data-act="rename">이름</button>
          <button data-act="del">삭제</button>
        </div>
      `;
      el.addEventListener("click", (ev)=>{
        const act = ev.target?.dataset?.act;
        if(act === "rename"){
          openRenameModal("page", p.id, p.name);
          ev.stopPropagation();
          return;
        }
        if(act === "del"){
          if(confirm("이 페이지를 삭제할까요? (복구 불가)")){
            if(p.mapKey) idbDel(p.mapKey).catch(()=>{});
            g.pages = g.pages.filter(x=>x.id!==p.id);
            if(state.data.activePageId === p.id){
              state.data.activePageId = g.pages[0]?.id || null;
            }
            saveData();
            loadActiveMap();
          }
          ev.stopPropagation();
          return;
        }

        state.data.activePageId = p.id;
        state.selectedMarkerId = null;
        saveData();
        loadActiveMap();
      });

      pageList.appendChild(el);
    });
  }

  function renderStyleInputs(){
    const p = getActivePage();
    if(!p) return;
    const st = p.style || (p.style = {});
    styleRadius.value = String(st.radius ?? 18);
    styleFont.value = String(st.fontSize ?? 13);
    styleFill.value = String(st.fill ?? "#2d6bff");
    styleText.value = String(st.text ?? "#ffffff");
  }

  function renderAll(){
    renderGames();
    renderPages();
    renderStyleInputs();
    draw();
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  /***********************
   * Map load / set
   ***********************/
  async function loadActiveMap(){
    state.img = null;
    if(state.imgUrl){
      URL.revokeObjectURL(state.imgUrl);
      state.imgUrl = null;
    }
    const p = getActivePage();
    if(!p || !p.mapKey){
      draw();
      return;
    }
    const blob = await idbGet(p.mapKey);
    if(!blob){
      p.mapKey = null;
      p.mapW = 0; p.mapH = 0;
      saveData();
      return;
    }
    const url = URL.createObjectURL(blob);
    state.imgUrl = url;
    const img = new Image();
    img.onload = ()=>{
      state.img = img;
      // if dimensions missing
      if(!p.mapW || !p.mapH){
        p.mapW = img.naturalWidth;
        p.mapH = img.naturalHeight;
        saveData();
      }
      fitToScreen();
      draw();
    };
    img.src = url;
  }

  mapFile.addEventListener("change", async ()=>{
    const file = mapFile.files?.[0];
    if(!file) return;
    const p = getActivePage();
    if(!p) return;

    // store
    const key = "map-" + uid();
    await idbPut(key, file);

    // remove previous
    if(p.mapKey) await idbDel(p.mapKey).catch(()=>{});

    p.mapKey = key;

    // measure dimensions
    const url = URL.createObjectURL(file);
    const img = new Image();
    img.onload = ()=>{
      p.mapW = img.naturalWidth;
      p.mapH = img.naturalHeight;
      URL.revokeObjectURL(url);
      saveData();
      loadActiveMap();
    };
    img.src = url;
  });

  btnClearMap.addEventListener("click", async ()=>{
    const p = getActivePage();
    if(!p) return;
    if(!p.mapKey) return;
    if(!confirm("이 페이지의 지도 이미지를 삭제할까요?")) return;
    await idbDel(p.mapKey).catch(()=>{});
    p.mapKey = null;
    p.mapW = 0; p.mapH = 0;
    saveData();
    loadActiveMap();
  });

  btnFit.addEventListener("click", fitToScreen);

  /***********************
   * Game/Page actions
   ***********************/
  btnAddGame.addEventListener("click", ()=>{
    const name = prompt("게임 이름을 입력하세요", "새 게임");
    if(!name) return;
    const g = { id: uid(), name: name.trim(), pages: [] };
    const p = { id: uid(), name: "1번마을", mapKey: null, mapW: 0, mapH: 0, markers: [], style: {
      radius: 18, fontSize: 13, fill: randColor(), text: "#ffffff"
    }};
    g.pages.push(p);
    state.data.games.push(g);
    state.data.activeGameId = g.id;
    state.data.activePageId = p.id;
    saveData();
    loadActiveMap();
  });

  btnAddPage.addEventListener("click", ()=>{
    const g = getActiveGame();
    if(!g) return;
    const name = prompt("페이지 이름을 입력하세요", `${g.pages.length+1}번마을`);
    if(!name) return;
    const p = { id: uid(), name: name.trim(), mapKey: null, mapW: 0, mapH: 0, markers: [], style: {
      radius: 18, fontSize: 13, fill: randColor(), text: "#ffffff"
    }};
    g.pages.push(p);
    state.data.activePageId = p.id;
    saveData();
    loadActiveMap();
  });

  btnRenamePage.addEventListener("click", ()=>{
    const p = getActivePage();
    if(!p) return;
    openRenameModal("page", p.id, p.name);
  });

  /***********************
   * Style apply
   ***********************/
  function randColor(){
    const colors = ["#2d6bff","#8b5cf6","#22c55e","#f97316","#ef4444","#06b6d4","#eab308"];
    return colors[Math.floor(Math.random()*colors.length)];
  }

  btnRandomStyle.addEventListener("click", ()=>{
    styleFill.value = randColor();
    styleText.value = "#ffffff";
  });

  btnApplyStyle.addEventListener("click", ()=>{
    const p = getActivePage();
    if(!p) return;
    const st = p.style || (p.style = {});
    st.radius = clampInt(styleRadius.value, 6, 60, 18);
    st.fontSize = clampInt(styleFont.value, 8, 40, 13);
    st.fill = (styleFill.value || "#2d6bff").trim();
    st.text = (styleText.value || "#ffffff").trim();
    saveData();
  });

  function clampInt(v, min, max, d){
    const n = parseInt(v,10);
    if(Number.isNaN(n)) return d;
    return Math.max(min, Math.min(max, n));
  }

  /***********************
   * Marker dim reset
   ***********************/
  btnResetOpacity.addEventListener("click", ()=>{
    const p = getActivePage();
    if(!p) return;
    p.markers.forEach(m=>m.dim=false);
    saveData();
  });

  /***********************
   * Marker modal
   ***********************/
  function openMarkerModal(markerId){
    const p = getActivePage();
    if(!p) return;
    const m = p.markers.find(x=>x.id===markerId);
    if(!m) return;

    markerModalTitle.textContent = "마커 편집";
    markerText.value = m.text || "";
    markerYoutube.value = m.youtube || "";
    markerYoutubeTitle.value = m.youtubeTitle || "";
    markerMemo.value = m.memo || "";

    markerModal.classList.add("on");

    // Enter = save (but not inside textarea)
    const onKey = (e)=>{
      if(e.key === "Enter" && document.activeElement !== markerMemo){
        e.preventDefault();
        markerSave.click();
      }
    };
    markerModal._onKey = onKey;
    window.addEventListener("keydown", onKey);
    setTimeout(()=>markerText.focus(), 30);
  }

  function closeMarkerModal(){
    markerModal.classList.remove("on");
    if(markerModal._onKey){
      window.removeEventListener("keydown", markerModal._onKey);
      markerModal._onKey = null;
    }
  }

  markerModalClose.addEventListener("click", closeMarkerModal);
  markerModal.addEventListener("click", (e)=>{
    if(e.target === markerModal) closeMarkerModal();
  });

  markerSave.addEventListener("click", ()=>{
    const p = getActivePage();
    if(!p) return;
    const m = p.markers.find(x=>x.id===state.selectedMarkerId);
    if(!m) return;

    m.text = markerText.value || "";
    m.youtube = markerYoutube.value || "";
    m.youtubeTitle = markerYoutubeTitle.value || "";
    m.memo = markerMemo.value || "";
    saveData();
    closeMarkerModal();
  });

  markerDelete.addEventListener("click", ()=>{
    const p = getActivePage();
    if(!p) return;
    const idx = p.markers.findIndex(x=>x.id===state.selectedMarkerId);
    if(idx < 0) return;
    if(!confirm("이 마커를 삭제할까요?")) return;
    p.markers.splice(idx,1);
    state.selectedMarkerId = null;
    saveData();
    closeMarkerModal();
  });

  /***********************
   * Rename modal
   ***********************/
  function openRenameModal(type, id, current){
    renameModal.classList.add("on");
    renameInput.value = current || "";
    renameInput.focus();
    renameInput.select();
    renameTitle.textContent = (type === "game") ? "게임 이름 변경" : "페이지 이름 변경";
    renameModal.dataset.type = type;
    renameModal.dataset.id = id;
  }
  function closeRenameModal(){
    renameModal.classList.remove("on");
    renameModal.dataset.type = "";
    renameModal.dataset.id = "";
  }
  renameClose.addEventListener("click", closeRenameModal);
  renameModal.addEventListener("click", (e)=>{
    if(e.target === renameModal) closeRenameModal();
  });
  renameSave.addEventListener("click", ()=>{
    const type = renameModal.dataset.type;
    const id = renameModal.dataset.id;
    const name = (renameInput.value || "").trim();
    if(!name) return;

    if(type === "game"){
      const g = state.data.games.find(x=>x.id===id);
      if(g) g.name = name;
    }else if(type === "page"){
      const g = getActiveGame();
      const p = g?.pages.find(x=>x.id===id);
      if(p) p.name = name;
    }
    saveData();
    closeRenameModal();
  });
  renameInput.addEventListener("keydown", (e)=>{
    if(e.key === "Enter") renameSave.click();
  });

  /***********************
   * Export / Import JSON
   ***********************/
  btnExport.addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(state.data, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "mode_map_data.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 500);
  });

  btnImport.addEventListener("click", ()=>{
    importFile.value = "";
    importFile.click();
  });

  importFile.addEventListener("change", async ()=>{
    const f = importFile.files?.[0];
    if(!f) return;
    try{
      const txt = await f.text();
      const obj = JSON.parse(txt);
      if(!obj || !obj.games) throw new Error("invalid");
      state.data = obj;
      localStorage.setItem(LS_KEY, JSON.stringify(state.data));
      ensureDefault();
      renderAll();
      await loadActiveMap();
      alert("가져오기 완료!");
    }catch(e){
      alert("가져오기 실패: JSON 형식이 올바르지 않습니다.");
    }
  });

  /***********************
   * Init
   ***********************/
  function boot(){
    resizeCanvas();
    renderAll();
    loadActiveMap();
  }
  boot();
  </script>
</body>
</html>
